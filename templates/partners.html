<style>
    /* CSS Variables */
    :root {
        --primary-color: #2563eb;
        --primary-hover: #1d4ed8;
        --primary-light: #3b82f6;
        --background: #f8fafc;
        --surface: #ffffff;
        --border-color: #e2e8f0;
        --text-primary: #1e293b;
        --text-secondary: #64748b;
        --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
        --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
    }

    /* Container */
    .partners-container {
        padding: 20px;
        max-width: 1400px;
        margin: 0 auto;
    }

    /* Material Design Card */
    .partners-card {
        background-color: var(--surface);
        border-radius: 8px;
        box-shadow: 0 2px 1px -1px rgba(0,0,0,0.2),
                    0 1px 1px 0 rgba(0,0,0,0.14),
                    0 1px 3px 0 rgba(0,0,0,0.12);
        overflow: hidden;
    }

    /* Card Header */
    .partners-header {
        padding: 20px 24px;
        background: linear-gradient(135deg, var(--primary-color) 0%, var(--primary-light) 100%);
        color: white;
    }

    .partners-title {
        font-size: 1.5rem;
        font-weight: 500;
        margin: 0 0 16px 0;
    }

    /* Filters */
    .filters-row {
        display: flex;
        gap: 16px;
        align-items: flex-end;
        flex-wrap: wrap;
    }

    .filter-group {
        display: flex;
        flex-direction: column;
        gap: 8px;
    }

    .filter-label {
        font-size: 0.875rem;
        font-weight: 500;
        opacity: 0.95;
    }

    .filter-input, .filter-select {
        padding: 8px 12px;
        border: 1px solid rgba(255, 255, 255, 0.3);
        border-radius: 4px;
        background-color: rgba(255, 255, 255, 0.15);
        color: white;
        font-size: 0.875rem;
        transition: all 0.2s ease;
        min-width: 200px;
    }

    .filter-input::placeholder {
        color: rgba(255, 255, 255, 0.6);
    }

    .filter-input:focus, .filter-select:focus {
        outline: none;
        background-color: rgba(255, 255, 255, 0.25);
        border-color: rgba(255, 255, 255, 0.5);
    }

    .filter-select option {
        color: var(--text-primary);
        background-color: var(--surface);
    }

    .filter-btn {
        padding: 8px 24px;
        border: 1px solid rgba(255, 255, 255, 0.5);
        border-radius: 4px;
        background-color: rgba(255, 255, 255, 0.2);
        color: white;
        font-size: 0.875rem;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s ease;
        height: 38px;
    }

    .filter-btn:hover {
        background-color: rgba(255, 255, 255, 0.3);
        border-color: rgba(255, 255, 255, 0.7);
    }

    /* Table Container */
    .table-container {
        overflow-x: auto;
        padding: 24px;
    }

    /* Material Design Table */
    .partners-table {
        width: 100%;
        border-collapse: collapse;
    }

    .partners-table thead {
        background-color: var(--background);
    }

    .partners-table th {
        padding: 16px;
        text-align: left;
        font-weight: 600;
        font-size: 0.875rem;
        color: var(--text-primary);
        text-transform: uppercase;
        letter-spacing: 0.05em;
        border-bottom: 2px solid var(--border-color);
        position: sticky;
        top: 0;
        background-color: var(--background);
        z-index: 10;
    }

    .partners-table th input {
        width: 100%;
        padding: 6px 8px;
        border: 1px solid var(--border-color);
        border-radius: 4px;
        font-size: 0.875rem;
        margin-top: 8px;
        transition: all 0.2s ease;
    }

    .partners-table th input:focus {
        outline: none;
        border-color: var(--primary-color);
        box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
    }

    /* Filter toggle */
    .filter-toggle-icon {
        cursor: pointer;
        margin-left: 8px;
        font-size: 1rem;
        color: var(--text-secondary);
        transition: transform 0.2s ease;
        display: inline-block;
        user-select: none;
    }

    .filter-toggle-icon:hover {
        color: var(--primary-color);
    }

    .filter-toggle-icon.rotated {
        transform: rotate(180deg);
    }

    .column-filter {
        display: none;
    }

    .column-filter.visible {
        display: block;
    }

    .partners-table tbody tr {
        border-bottom: 1px solid var(--border-color);
        transition: background-color 0.2s ease;
    }

    .partners-table tbody tr:hover {
        background-color: var(--background);
    }

    .partners-table td {
        padding: 16px;
        font-size: 0.875rem;
        color: var(--text-primary);
    }

    /* Level badges */
    .level-badge {
        display: inline-block;
        padding: 4px 12px;
        border-radius: 16px;
        font-size: 0.75rem;
        font-weight: 500;
    }

    .level-current {
        background-color: #dbeafe;
        color: #1e40af;
    }

    .level-threshold {
        background-color: #dcfce7;
        color: #166534;
    }

    .level-mismatch {
        background-color: #fef3c7;
        color: #92400e;
    }

    /* Pagination */
    .pagination-container {
        padding: 16px 24px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        border-top: 1px solid var(--border-color);
    }

    .pagination-info {
        font-size: 0.875rem;
        color: var(--text-secondary);
    }

    .pagination-controls {
        display: flex;
        gap: 8px;
    }

    .pagination-btn {
        padding: 8px 16px;
        border: 1px solid var(--border-color);
        border-radius: 4px;
        background-color: var(--surface);
        color: var(--text-primary);
        font-size: 0.875rem;
        cursor: pointer;
        transition: all 0.2s ease;
    }

    .pagination-btn:hover:not(:disabled) {
        background-color: var(--background);
        border-color: var(--primary-color);
        color: var(--primary-color);
    }

    .pagination-btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }

    .pagination-btn.active {
        background-color: var(--primary-color);
        color: white;
        border-color: var(--primary-color);
    }

    /* Loading and Error states */
    .loading, .error {
        text-align: center;
        padding: 40px;
        color: var(--text-secondary);
    }

    .error {
        background-color: #fee2e2;
        color: #991b1b;
        border-radius: 8px;
        margin: 20px;
    }

    /* Number formatting */
    .number-cell {
        text-align: right;
        font-variant-numeric: tabular-nums;
    }
</style>

<div id="partners" class="partners-container">
    <div class="partners-card">
        <div class="partners-header">
            <h1 class="partners-title">Анализ партнеров</h1>
            <div class="filters-row">
                <div class="filter-group">
                    <label class="filter-label">Год</label>
                    <select id="yearFilter" class="filter-select">
                        <option value="2023">2023</option>
                        <option value="2024">2024</option>
                        <option value="2025" selected>2025</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label class="filter-label">Партнер</label>
                    <input type="text" id="partnerFilter" class="filter-input" placeholder="Введите название партнера">
                </div>
                <button id="applyFilters" class="filter-btn">Применить</button>
                <button id="resetFilters" class="filter-btn">Сбросить</button>
            </div>
        </div>
        <div class="table-container">
            <table class="partners-table">
                <thead>
                    <tr>
                        <th>
                            <span>Партнер <span class="filter-toggle-icon" title="Показать/скрыть фильтр">▼</span></span>
                            <input type="text" class="column-filter" data-column="Партнер" placeholder="Фильтр...">
                        </th>
                        <th>
                            <span>Дистрибьютор <span class="filter-toggle-icon" title="Показать/скрыть фильтр">▼</span></span>
                            <input type="text" class="column-filter" data-column="Дистрибьютор" placeholder="Фильтр...">
                        </th>
                        <th>
                            <span>Сделок <span class="filter-toggle-icon" title="Показать/скрыть фильтр">▼</span></span>
                            <input type="text" class="column-filter" data-column="Сделок" placeholder="Фильтр...">
                        </th>
                        <th>
                            <span>Сумма оплат <span class="filter-toggle-icon" title="Показать/скрыть фильтр">▼</span></span>
                            <input type="text" class="column-filter" data-column="Сумма оплат" placeholder="Фильтр...">
                        </th>
                        <th>
                            <span>Год <span class="filter-toggle-icon" title="Показать/скрыть фильтр">▼</span></span>
                            <input type="text" class="column-filter" data-column="Год" placeholder="Фильтр...">
                        </th>
                        <th>
                            <span>Текущий уровень <span class="filter-toggle-icon" title="Показать/скрыть фильтр">▼</span></span>
                            <input type="text" class="column-filter" data-column="Уровень" placeholder="Фильтр...">
                        </th>
                        <th>
                            <span>Уровень по порогу <span class="filter-toggle-icon" title="Показать/скрыть фильтр">▼</span></span>
                            <input type="text" class="column-filter" data-column="УровеньПоПорогу" placeholder="Фильтр...">
                        </th>
                    </tr>
                </thead>
                <tbody id="partnersTableBody">
                    <tr>
                        <td colspan="7" class="loading">Загрузка данных...</td>
                    </tr>
                </tbody>
            </table>
        </div>
        <div class="pagination-container" id="paginationContainer" style="display: none;">
            <div class="pagination-info" id="paginationInfo"></div>
            <div class="pagination-controls" id="paginationControls"></div>
        </div>
    </div>
</div>

<script>
// Partners functionality
var partnersData = [];
var levelsData = [];
var filteredData = [];
var currentPage = 1;
var itemsPerPage = 20;

// Get current year
var currentYear = new Date().getFullYear();

// Update year filter to include current year if it's beyond 2025
if(currentYear > 2025){
    var yearSelect = document.getElementById('yearFilter');
    yearSelect.innerHTML = '';
    for(var year = 2023; year <= currentYear; year++){
        var option = document.createElement('option');
        option.value = year;
        option.textContent = year;
        if(year === currentYear){
            option.selected = true;
        }
        yearSelect.appendChild(option);
    }
}

function loadPartnersData(){
    document.getElementById('partnersTableBody').innerHTML = '<tr><td colspan="7" class="loading">Загрузка данных...</td></tr>';

    // Load partners data
    var xhr1 = new XMLHttpRequest();
    var yearFilter = document.getElementById('yearFilter').value;
    var partnerFilter = document.getElementById('partnerFilter').value.trim();

    var url = 'https://' + window.location.hostname + '/' + db + '/report/4339?JSON_KV&FR_Год=' + yearFilter;
    if(partnerFilter){
        // Wrap partner filter value with % for MySQL LIKE pattern matching
        url += '&FR_Партнер=' + encodeURIComponent('%' + partnerFilter + '%');
    }

    xhr1.open('GET', url, true);
    xhr1.onload = function(){
        if(xhr1.status === 200){
            try{
                partnersData = JSON.parse(xhr1.responseText);
                checkDataLoaded();
            } catch(e){
                showError('Ошибка парсинга данных партнеров: ' + e.message);
            }
        } else {
            showError('Ошибка загрузки данных партнеров: ' + xhr1.status);
        }
    };
    xhr1.onerror = function(){
        showError('Ошибка сети при загрузке данных партнеров');
    };
    xhr1.send();

    // Load levels data
    var xhr2 = new XMLHttpRequest();
    xhr2.open('GET', 'https://' + window.location.hostname + '/' + db + '/report/4474?JSON_KV', true);
    xhr2.onload = function(){
        if(xhr2.status === 200){
            try{
                levelsData = JSON.parse(xhr2.responseText);
                checkDataLoaded();
            } catch(e){
                showError('Ошибка парсинга данных уровней: ' + e.message);
            }
        } else {
            showError('Ошибка загрузки данных уровней: ' + xhr2.status);
        }
    };
    xhr2.onerror = function(){
        showError('Ошибка сети при загрузке данных уровней');
    };
    xhr2.send();
}

function checkDataLoaded(){
    if(partnersData.length > 0 && levelsData.length > 0){
        processData();
        renderTable();
    } else if(partnersData.length === 0 && levelsData.length > 0){
        // No data found after applying filters
        document.getElementById('partnersTableBody').innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 40px; color: var(--text-secondary);">Данные не найдены</td></tr>';
    }
}

function showError(message){
    document.getElementById('partnersTableBody').innerHTML = '<tr><td colspan="7" class="error">' + message + '</td></tr>';
}

function processData(){
    // Sort levels by threshold in descending order for easier matching
    levelsData.sort(function(a, b){
        return parseFloat(b['Порог']) - parseFloat(a['Порог']);
    });

    // Calculate threshold-based level for each partner
    partnersData.forEach(function(partner){
        var sumStr = partner['Сумма оплат'] ? partner['Сумма оплат'].toString().replace(/\s/g, '') : '0';
        var sum = parseFloat(sumStr);

        // Find the appropriate level based on threshold
        var levelByThreshold = 'Не определен';
        for(var i = 0; i < levelsData.length; i++){
            var threshold = parseFloat(levelsData[i]['Порог']);
            if(sum >= threshold){
                levelByThreshold = levelsData[i]['Уровень'];
                break;
            }
        }

        partner['УровеньПоПорогу'] = levelByThreshold;
    });

    // Initialize filtered data with all data
    filteredData = partnersData.slice();
}

function decodeHtmlEntities(text){
    if(!text) return text;
    var txt = document.createElement('textarea');
    txt.innerHTML = text;
    return txt.value;
}

function applyColumnFilters(){
    var filters = {};
    var filterInputs = document.querySelectorAll('.column-filter');

    filterInputs.forEach(function(input){
        var column = input.getAttribute('data-column');
        var value = input.value.trim().toLowerCase();
        if(value){
            filters[column] = value;
        }
    });

    if(Object.keys(filters).length === 0){
        filteredData = partnersData.slice();
    } else {
        filteredData = partnersData.filter(function(partner){
            for(var column in filters){
                var cellValue = partner[column] ? partner[column].toString().toLowerCase() : '';
                if(cellValue.indexOf(filters[column]) === -1){
                    return false;
                }
            }
            return true;
        });
    }

    currentPage = 1;
    renderTable();
}

function renderTable(){
    var tbody = document.getElementById('partnersTableBody');
    tbody.innerHTML = '';

    if(filteredData.length === 0){
        tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 40px; color: var(--text-secondary);">Нет данных для отображения</td></tr>';
        document.getElementById('paginationContainer').style.display = 'none';
        return;
    }

    // Calculate pagination
    var totalPages = Math.ceil(filteredData.length / itemsPerPage);
    var startIndex = (currentPage - 1) * itemsPerPage;
    var endIndex = Math.min(startIndex + itemsPerPage, filteredData.length);
    var pageData = filteredData.slice(startIndex, endIndex);

    // Render rows
    pageData.forEach(function(partner){
        var tr = document.createElement('tr');

        // Партнер (as HTML - may contain hyperlinks)
        var td1 = document.createElement('td');
        td1.innerHTML = partner['Партнер'] || '';
        tr.appendChild(td1);

        // Дистрибьютор
        var td2 = document.createElement('td');
        td2.textContent = partner['Дистрибьютор'] || '';
        tr.appendChild(td2);

        // Сделок
        var td3 = document.createElement('td');
        td3.className = 'number-cell';
        td3.textContent = partner['Сделок'] || '0';
        tr.appendChild(td3);

        // Сумма оплат
        var td4 = document.createElement('td');
        td4.className = 'number-cell';
        if(partner['Сумма оплат']){
            var sumStr = partner['Сумма оплат'].toString().replace(/\s/g, '');
            var sum = parseFloat(sumStr);
            td4.textContent = sum.toLocaleString('ru-RU') + ' ₽';
        } else {
            td4.textContent = '0 ₽';
        }
        tr.appendChild(td4);

        // Год
        var td5 = document.createElement('td');
        td5.className = 'number-cell';
        td5.textContent = partner['Год'] || '';
        tr.appendChild(td5);

        // Текущий уровень
        var td6 = document.createElement('td');
        var currentLevel = partner['Уровень'] || 'Не определен';
        var badge1 = document.createElement('span');
        badge1.className = 'level-badge level-current';
        badge1.textContent = currentLevel;
        td6.appendChild(badge1);
        tr.appendChild(td6);

        // Уровень по порогу
        var td7 = document.createElement('td');
        var thresholdLevel = partner['УровеньПоПорогу'] || 'Не определен';
        var badge2 = document.createElement('span');
        badge2.className = 'level-badge';

        // Add appropriate class based on match
        if(currentLevel === thresholdLevel){
            badge2.className += ' level-threshold';
        } else {
            badge2.className += ' level-mismatch';
        }

        badge2.textContent = thresholdLevel;
        td7.appendChild(badge2);
        tr.appendChild(td7);

        tbody.appendChild(tr);
    });

    // Render pagination
    renderPagination(totalPages, startIndex, endIndex);
}

function renderPagination(totalPages, startIndex, endIndex){
    var container = document.getElementById('paginationContainer');
    var info = document.getElementById('paginationInfo');
    var controls = document.getElementById('paginationControls');

    if(totalPages <= 1){
        container.style.display = 'none';
        return;
    }

    container.style.display = 'flex';

    // Update info
    info.textContent = 'Показаны ' + (startIndex + 1) + '-' + endIndex + ' из ' + filteredData.length + ' записей';

    // Update controls
    controls.innerHTML = '';

    // Previous button
    var prevBtn = document.createElement('button');
    prevBtn.className = 'pagination-btn';
    prevBtn.textContent = '← Назад';
    prevBtn.disabled = currentPage === 1;
    prevBtn.onclick = function(){
        if(currentPage > 1){
            currentPage--;
            renderTable();
        }
    };
    controls.appendChild(prevBtn);

    // Page numbers
    var maxButtons = 5;
    var startPage = Math.max(1, currentPage - Math.floor(maxButtons / 2));
    var endPage = Math.min(totalPages, startPage + maxButtons - 1);

    if(endPage - startPage < maxButtons - 1){
        startPage = Math.max(1, endPage - maxButtons + 1);
    }

    for(var i = startPage; i <= endPage; i++){
        var pageBtn = document.createElement('button');
        pageBtn.className = 'pagination-btn';
        if(i === currentPage){
            pageBtn.className += ' active';
        }
        pageBtn.textContent = i;
        pageBtn.setAttribute('data-page', i);
        pageBtn.onclick = function(){
            currentPage = parseInt(this.getAttribute('data-page'));
            renderTable();
        };
        controls.appendChild(pageBtn);
    }

    // Next button
    var nextBtn = document.createElement('button');
    nextBtn.className = 'pagination-btn';
    nextBtn.textContent = 'Вперед →';
    nextBtn.disabled = currentPage === totalPages;
    nextBtn.onclick = function(){
        if(currentPage < totalPages){
            currentPage++;
            renderTable();
        }
    };
    controls.appendChild(nextBtn);
}

// Event listeners
document.getElementById('applyFilters').addEventListener('click', function(){
    currentPage = 1;
    loadPartnersData();
});

document.getElementById('resetFilters').addEventListener('click', function(){
    document.getElementById('yearFilter').value = currentYear <= 2025 ? '2025' : currentYear.toString();
    document.getElementById('partnerFilter').value = '';

    // Clear column filters
    var filterInputs = document.querySelectorAll('.column-filter');
    filterInputs.forEach(function(input){
        input.value = '';
    });

    currentPage = 1;
    loadPartnersData();
});

// Add change handler for year filter to apply automatically
document.getElementById('yearFilter').addEventListener('change', function(){
    currentPage = 1;
    loadPartnersData();
});

// Add Enter key handler for filter inputs in blue header
document.getElementById('yearFilter').addEventListener('keydown', function(e){
    if(e.key === 'Enter'){
        currentPage = 1;
        loadPartnersData();
    }
});

document.getElementById('partnerFilter').addEventListener('keydown', function(e){
    if(e.key === 'Enter'){
        currentPage = 1;
        loadPartnersData();
    }
});

// Column filter inputs
document.addEventListener('input', function(e){
    if(e.target.classList.contains('column-filter')){
        applyColumnFilters();
    }
});

// Filter toggle functionality
document.addEventListener('click', function(e){
    if(e.target.classList.contains('filter-toggle-icon')){
        var th = e.target.closest('th');
        var filterInput = th.querySelector('.column-filter');

        if(filterInput){
            filterInput.classList.toggle('visible');
            e.target.classList.toggle('rotated');
        }
    }
});

// Load data on page load
document.addEventListener('DOMContentLoaded', function(){
    loadPartnersData();
});

// Also support legacy jQuery ready
if(typeof $ !== 'undefined'){
    $(document).ready(function(){
        loadPartnersData();
    });
}
</script>
