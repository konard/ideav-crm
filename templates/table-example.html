<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">
    <title>Пример использования Integram Table</title>
    <style>
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .page-header {
            margin-bottom: 30px;
        }

        .example-section {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 30px;
        }

        pre {
            background: #f5f5f5;
            padding: 15px;
            border-radius: 4px;
            overflow-x: auto;
        }

        code {
            color: #d73a49;
        }

        .integram-table-wrapper {
            position: relative;
            margin: 20px 0;
        }

        .integram-table-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .integram-table-settings {
            cursor: pointer;
            padding: 8px;
            border-radius: 4px;
            transition: background-color 0.2s;
        }

        .integram-table-settings:hover {
            background-color: #f0f0f0;
        }

        .integram-table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        .integram-table th {
            background: #f8f9fa;
            padding: 12px;
            text-align: left;
            font-weight: 600;
            border-bottom: 2px solid #dee2e6;
            position: relative;
            cursor: move;
            user-select: none;
        }

        .integram-table th.dragging {
            opacity: 0.5;
            background: #e9ecef;
        }

        .integram-table th.drag-over {
            border-left: 3px solid #007bff;
        }

        .integram-table td {
            padding: 10px 12px;
            border-bottom: 1px solid #dee2e6;
        }

        .integram-table tr:hover {
            background-color: #f8f9fa;
        }

        .integram-table .number-cell {
            text-align: right;
        }

        .integram-table .boolean-cell {
            text-align: center;
        }

        .integram-table .date-cell,
        .integram-table .datetime-cell {
            white-space: nowrap;
        }

        .integram-table .memo-cell {
            max-width: 300px;
            white-space: pre-wrap;
        }

        .integram-table .pwd-cell {
            font-family: monospace;
        }

        .filter-row td {
            padding: 5px;
            background: #f8f9fa;
        }

        .filter-cell {
            display: flex;
            align-items: center;
        }

        .filter-type {
            padding: 4px 8px;
            margin-right: 5px;
            cursor: pointer;
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 3px;
            font-size: 14px;
            min-width: 30px;
            text-align: center;
        }

        .filter-type:hover {
            background: #e9ecef;
        }

        .filter-input {
            flex: 1;
            padding: 4px 8px;
            border: 1px solid #dee2e6;
            border-radius: 3px;
            font-size: 14px;
        }

        .pagination-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 15px;
            padding: 10px 0;
        }

        .pagination-controls button {
            padding: 6px 12px;
            margin: 0 2px;
            border: 1px solid #dee2e6;
            background: white;
            border-radius: 3px;
            cursor: pointer;
        }

        .pagination-controls button:hover:not(:disabled) {
            background: #e9ecef;
        }

        .pagination-controls button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .column-settings-modal {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.2);
            z-index: 1000;
            max-width: 400px;
            width: 90%;
        }

        .column-settings-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 999;
        }

        .column-settings-list {
            max-height: 400px;
            overflow-y: auto;
            margin: 15px 0;
        }

        .column-settings-item {
            padding: 8px;
            border-bottom: 1px solid #f0f0f0;
            display: flex;
            align-items: center;
        }

        .column-settings-item label {
            margin: 0;
            cursor: pointer;
            display: flex;
            align-items: center;
            width: 100%;
        }

        .column-settings-item input[type="checkbox"] {
            margin-right: 10px;
        }

        .filter-type-menu {
            position: absolute;
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
            z-index: 100;
            min-width: 200px;
        }

        .filter-type-option {
            padding: 8px 12px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .filter-type-option:hover {
            background: #f8f9fa;
        }

        .filter-type-option .symbol {
            font-weight: bold;
            margin-right: 8px;
        }
    </style>
    <script src="/js/jquery.min.js"></script>
    <script src="/js/jquery-ui.min.js"></script>
</head>
<body>

<div class="container">
    <div class="page-header">
        <h1>Integram Table Component</h1>
        <p class="text-muted">Компонент для отображения табличных данных из Integram API</p>
    </div>

    <div class="example-section">
        <h3>Описание</h3>
        <p>Компонент предоставляет полнофункциональную таблицу для отображения данных из Integram с поддержкой:</p>
        <ul>
            <li>✅ Пагинации (по 20 записей)</li>
            <li>✅ Динамических колонок с различными форматами (SHORT, CHARS, NUMBER, DATE, DATETIME, BOOLEAN, MEMO, HTML, BUTTON, PWD)</li>
            <li>✅ Перетаскивания колонок для изменения порядка</li>
            <li>✅ Скрытия/показа колонок через настройки</li>
            <li>✅ Фильтрации по любому полю с различными операторами</li>
            <li>✅ Сохранения настроек в cookies браузера</li>
        </ul>
    </div>

    <div class="example-section">
        <h3>Использование</h3>
        <pre><code>&lt;!-- Подключение необходимых библиотек --&gt;
&lt;script src="/js/jquery.min.js"&gt;&lt;/script&gt;
&lt;script src="/js/jquery-ui.min.js"&gt;&lt;/script&gt;

&lt;!-- Контейнер для таблицы --&gt;
&lt;div id="my-table"&gt;&lt;/div&gt;

&lt;!-- Подключение компонента --&gt;
&lt;script src="integram-table.html"&gt;&lt;/script&gt;

&lt;!-- Инициализация --&gt;
&lt;script&gt;
// Пример 1: Простая инициализация
const table = new IntegramTable('my-table', {
    apiUrl: '/api/tasks',  // URL для получения данных
    pageSize: 20,          // Количество записей на странице
    cookiePrefix: 'tasks-table'  // Префикс для cookies
});

// Пример 2: С обработчиками событий
const table2 = new IntegramTable('my-table', {
    apiUrl: '/api/tasks',
    pageSize: 20,
    onCellClick: (row, col, value) => {
        console.log('Clicked:', row, col, value);
    },
    onDataLoad: (data) => {
        console.log('Data loaded:', data);
    }
});
&lt;/script&gt;</code></pre>
    </div>

    <div class="example-section">
        <h3>Формат данных API</h3>
        <p>API должен возвращать JSON в следующем формате:</p>
        <pre><code>{
  "columns": [
    {
      "id": "4284",
      "type": "3596",
      "format": "CHARS",
      "name": "Задача",
      "granted": 1,
      "ref": 0
    },
    {
      "id": "4288",
      "type": "332",
      "format": "SHORT",
      "name": "Клиент",
      "granted": 1,
      "ref": 0
    }
  ],
  "data": [
    ["Задача 1", "Клиент 1"],
    ["Задача 2", "Клиент 2"]
  ],
  "total": 100
}</code></pre>
    </div>

    <div class="example-section">
        <h3>Операторы фильтрации</h3>
        <table class="table table-sm">
            <thead>
                <tr>
                    <th>Символ</th>
                    <th>Название</th>
                    <th>Применимо к типам</th>
                    <th>Формат параметра</th>
                </tr>
            </thead>
            <tbody>
                <tr><td>^</td><td>начинается с...</td><td>CHARS, MEMO, SHORT</td><td>FR_{T}={X}%</td></tr>
                <tr><td>=</td><td>равно</td><td>Все типы</td><td>FR_{T}={X}</td></tr>
                <tr><td>≠</td><td>не равно</td><td>Все типы</td><td>FR_{T}=!{X}</td></tr>
                <tr><td>~</td><td>содержит</td><td>CHARS, MEMO, SHORT</td><td>FR_{T}=%{X}%</td></tr>
                <tr><td>!</td><td>не содержит</td><td>CHARS, MEMO, SHORT</td><td>FR_{T}=!%{X}%</td></tr>
                <tr><td>%</td><td>не пустое</td><td>Все типы</td><td>FR_{T}=%</td></tr>
                <tr><td>!%</td><td>пустое</td><td>Все типы</td><td>FR_{T}=!%</td></tr>
                <tr><td>≥</td><td>не меньше</td><td>NUMBER, DATE, DATETIME, SIGNED</td><td>FR_{T}>={X}</td></tr>
                <tr><td>≤</td><td>не больше</td><td>NUMBER, DATE, DATETIME, SIGNED</td><td>FR_{T}<={X}</td></tr>
                <tr><td>...</td><td>в диапазоне</td><td>NUMBER, DATE, DATETIME, SIGNED</td><td>FR_{T}={X1}&TO_{T}={X2}</td></tr>
            </tbody>
        </table>
    </div>

    <div class="example-section">
        <h3>Демонстрация (с тестовыми данными)</h3>
        <div id="demo-table"></div>
    </div>
</div>

<script>
// Include the IntegramTable class inline for this demo
class IntegramTable {
    constructor(containerId, options = {}) {
        this.container = document.getElementById(containerId);
        this.options = {
            apiUrl: options.apiUrl || '',
            pageSize: options.pageSize || 20,
            cookiePrefix: options.cookiePrefix || 'integram-table',
            onCellClick: options.onCellClick || null,
            onDataLoad: options.onDataLoad || null,
            mockData: options.mockData || null
        };

        this.columns = [];
        this.data = [];
        this.currentPage = 0;
        this.totalRows = 0;
        this.filters = {};
        this.columnOrder = [];
        this.visibleColumns = [];
        this.filtersEnabled = false;

        this.filterTypes = {
            'CHARS': [
                { symbol: '^', name: 'начинается с...', format: 'FR_{T}={X}%' },
                { symbol: '=', name: 'равно', format: 'FR_{T}={X}' },
                { symbol: '≠', name: 'не равно', format: 'FR_{T}=!{X}' },
                { symbol: '~', name: 'содержит', format: 'FR_{T}=%{X}%' },
                { symbol: '!', name: 'не содержит', format: 'FR_{T}=!%{X}%' },
                { symbol: '!^', name: 'не начинается', format: 'FR_{T}=!%{X}' },
                { symbol: '%', name: 'не пустое', format: 'FR_{T}=%' },
                { symbol: '!%', name: 'пустое', format: 'FR_{T}=!%' },
                { symbol: '(,)', name: 'в списке', format: 'FR_{T}=IN({X})' },
                { symbol: '$', name: 'заканчивается', format: 'FR_{T}=%{X}' }
            ],
            'NUMBER': [
                { symbol: '=', name: 'равно', format: 'FR_{T}={X}' },
                { symbol: '≠', name: 'не равно', format: 'FR_{T}=!{X}' },
                { symbol: '≥', name: 'не меньше', format: 'FR_{T}=>={X}' },
                { symbol: '≤', name: 'не больше', format: 'FR_{T}=<={X}' },
                { symbol: '>', name: 'больше', format: 'FR_{T}=>{X}' },
                { symbol: '<', name: 'меньше', format: 'FR_{T}=<{X}' },
                { symbol: '...', name: 'в диапазоне', format: 'FR_{T}={X1}&TO_{T}={X2}' },
                { symbol: '%', name: 'не пустое', format: 'FR_{T}=%' },
                { symbol: '!%', name: 'пустое', format: 'FR_{T}=!%' }
            ],
            'DATE': [
                { symbol: '=', name: 'равно', format: 'FR_{T}={X}' },
                { symbol: '≥', name: 'не меньше', format: 'FR_{T}=>={X}' },
                { symbol: '≤', name: 'не больше', format: 'FR_{T}=<={X}' },
                { symbol: '>', name: 'больше', format: 'FR_{T}=>{X}' },
                { symbol: '<', name: 'меньше', format: 'FR_{T}=<{X}' },
                { symbol: '...', name: 'в диапазоне', format: 'FR_{T}={X1}&TO_{T}={X2}' },
                { symbol: '%', name: 'не пустое', format: 'FR_{T}=%' },
                { symbol: '!%', name: 'пустое', format: 'FR_{T}=!%' }
            ]
        };

        this.filterTypes['SHORT'] = this.filterTypes['CHARS'];
        this.filterTypes['MEMO'] = this.filterTypes['CHARS'];
        this.filterTypes['DATETIME'] = this.filterTypes['DATE'];
        this.filterTypes['SIGNED'] = this.filterTypes['NUMBER'];

        this.init();
    }

    init() {
        this.loadColumnState();
        this.loadData();
    }

    async loadData() {
        if (this.options.mockData) {
            // Use mock data for demo
            const json = this.options.mockData;
            this.columns = json.columns || [];
            this.data = json.data || [];
            this.totalRows = json.total || this.data.length;

            if (this.columnOrder.length === 0) {
                this.columnOrder = this.columns.map(c => c.id);
            }
            if (this.visibleColumns.length === 0) {
                this.visibleColumns = this.columns.map(c => c.id);
            }

            this.render();
            return;
        }

        const offset = this.currentPage * this.options.pageSize;
        const params = new URLSearchParams({
            LIMIT: `${offset},${this.options.pageSize}`
        });

        Object.keys(this.filters).forEach(colId => {
            const filter = this.filters[colId];
            if (filter.value) {
                const column = this.columns.find(c => c.id === colId);
                if (column) {
                    this.applyFilter(params, column, filter);
                }
            }
        });

        try {
            const response = await fetch(`${this.options.apiUrl}?${params}`);
            const json = await response.json();

            this.columns = json.columns || [];
            this.data = json.data || [];
            this.totalRows = json.total || this.data.length;

            if (this.columnOrder.length === 0) {
                this.columnOrder = this.columns.map(c => c.id);
            }
            if (this.visibleColumns.length === 0) {
                this.visibleColumns = this.columns.map(c => c.id);
            }

            if (this.options.onDataLoad) {
                this.options.onDataLoad(json);
            }

            this.render();
        } catch (error) {
            console.error('Error loading data:', error);
            this.container.innerHTML = `<div class="alert alert-danger">Ошибка загрузки данных: ${error.message}</div>`;
        }
    }

    applyFilter(params, column, filter) {
        const type = filter.type || '^';
        const value = filter.value;
        const colId = column.id;

        const format = column.format || 'SHORT';
        const filterGroup = this.filterTypes[format] || this.filterTypes['SHORT'];
        const filterDef = filterGroup.find(f => f.symbol === type);

        if (!filterDef) return;

        if (type === '...') {
            const values = value.split(',').map(v => v.trim());
            if (values.length >= 2) {
                params.append(`FR_${colId}`, values[0]);
                params.append(`TO_${colId}`, values[1]);
            }
        } else if (type === '%' || type === '!%') {
            params.append(`FR_${colId}`, type === '%' ? '%' : '!%');
        } else {
            let paramValue = filterDef.format.replace('{T}', colId).replace('{X}', value);
            paramValue = paramValue.replace('FR_' + colId + '=', '');
            params.append(`FR_${colId}`, paramValue);
        }
    }

    render() {
        const orderedColumns = this.columnOrder
            .map(id => this.columns.find(c => c.id === id))
            .filter(c => c && this.visibleColumns.includes(c.id));

        let html = `
            <div class="integram-table-wrapper">
                <div class="integram-table-header">
                    <div>
                        <button class="btn btn-sm btn-outline-secondary" onclick="window.demoTable.toggleFilters()">
                            ${this.filtersEnabled ? '✓' : ''} Фильтры
                        </button>
                    </div>
                    <div class="integram-table-settings" onclick="window.demoTable.openColumnSettings()">
                        ⚙️ Настройки колонок
                    </div>
                </div>
                <table class="integram-table">
                    <thead>
                        <tr>
                            ${orderedColumns.map(col => `
                                <th data-column-id="${col.id}" draggable="true">
                                    ${col.name}
                                </th>
                            `).join('')}
                        </tr>
                        ${this.filtersEnabled ? `
                        <tr class="filter-row">
                            ${orderedColumns.map(col => this.renderFilterCell(col)).join('')}
                        </tr>
                        ` : ''}
                    </thead>
                    <tbody>
                        ${this.data.map((row, rowIndex) => `
                            <tr>
                                ${orderedColumns.map((col, colIndex) => {
                                    const cellValue = row[this.columns.indexOf(col)];
                                    return this.renderCell(col, cellValue, rowIndex, colIndex);
                                }).join('')}
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
                ${this.renderPagination()}
            </div>
        `;

        this.container.innerHTML = html;
        this.attachEventListeners();
    }

    renderFilterCell(column) {
        const format = column.format || 'SHORT';
        const filterGroup = this.filterTypes[format] || this.filterTypes['SHORT'];
        const currentFilter = this.filters[column.id] || { type: '^', value: '' };

        return `
            <td>
                <div class="filter-cell">
                    <span class="filter-type" data-column-id="${column.id}">
                        ${currentFilter.type}
                    </span>
                    <input type="text"
                           class="filter-input"
                           data-column-id="${column.id}"
                           value="${currentFilter.value}"
                           placeholder="Фильтр...">
                </div>
            </td>
        `;
    }

    renderCell(column, value, rowIndex, colIndex) {
        const format = column.format || 'SHORT';
        let cellClass = '';
        let displayValue = value || '';

        switch (format) {
            case 'NUMBER':
            case 'SIGNED':
                cellClass = 'number-cell';
                break;
            case 'BOOLEAN':
                cellClass = 'boolean-cell';
                displayValue = value ? 'Да' : 'Нет';
                break;
            case 'DATE':
                cellClass = 'date-cell';
                if (value) {
                    displayValue = new Date(value).toLocaleDateString('ru-RU');
                }
                break;
            case 'DATETIME':
                cellClass = 'datetime-cell';
                if (value) {
                    displayValue = new Date(value).toLocaleString('ru-RU');
                }
                break;
            case 'MEMO':
                cellClass = 'memo-cell';
                break;
            case 'PWD':
                cellClass = 'pwd-cell';
                displayValue = '******';
                break;
            case 'HTML':
                return `<td class="${cellClass}" data-row="${rowIndex}" data-col="${colIndex}">${displayValue}</td>`;
            case 'BUTTON':
                displayValue = `<button class="btn btn-sm btn-primary">${value || 'Действие'}</button>`;
                return `<td class="${cellClass}" data-row="${rowIndex}" data-col="${colIndex}">${displayValue}</td>`;
        }

        const escapedValue = String(displayValue).replace(/&/g, '&amp;')
                                                  .replace(/</g, '&lt;')
                                                  .replace(/>/g, '&gt;')
                                                  .replace(/"/g, '&quot;')
                                                  .replace(/'/g, '&#039;');

        return `<td class="${cellClass}" data-row="${rowIndex}" data-col="${colIndex}">${escapedValue}</td>`;
    }

    renderPagination() {
        const totalPages = Math.ceil(this.totalRows / this.options.pageSize);
        const hasNext = this.currentPage < totalPages - 1;
        const hasPrev = this.currentPage > 0;

        return `
            <div class="pagination-controls">
                <div>
                    Показано ${this.currentPage * this.options.pageSize + 1}-${Math.min((this.currentPage + 1) * this.options.pageSize, this.totalRows)} из ${this.totalRows}
                </div>
                <div>
                    <button ${!hasPrev ? 'disabled' : ''} onclick="window.demoTable.prevPage()">← Назад</button>
                    <span style="margin: 0 10px;">Страница ${this.currentPage + 1} из ${totalPages}</span>
                    <button ${!hasNext ? 'disabled' : ''} onclick="window.demoTable.nextPage()">Вперед →</button>
                </div>
            </div>
        `;
    }

    attachEventListeners() {
        const headers = this.container.querySelectorAll('th[draggable]');
        headers.forEach(th => {
            th.addEventListener('dragstart', (e) => {
                e.dataTransfer.effectAllowed = 'move';
                e.dataTransfer.setData('text/plain', th.dataset.columnId);
                th.classList.add('dragging');
            });

            th.addEventListener('dragend', (e) => {
                th.classList.remove('dragging');
                document.querySelectorAll('.drag-over').forEach(el => el.classList.remove('drag-over'));
            });

            th.addEventListener('dragover', (e) => {
                e.preventDefault();
                e.dataTransfer.dropEffect = 'move';
                th.classList.add('drag-over');
            });

            th.addEventListener('dragleave', (e) => {
                th.classList.remove('drag-over');
            });

            th.addEventListener('drop', (e) => {
                e.preventDefault();
                const draggedId = e.dataTransfer.getData('text/plain');
                const targetId = th.dataset.columnId;

                if (draggedId !== targetId) {
                    this.reorderColumns(draggedId, targetId);
                }

                th.classList.remove('drag-over');
            });
        });

        const filterTypes = this.container.querySelectorAll('.filter-type');
        filterTypes.forEach(ft => {
            ft.addEventListener('click', (e) => {
                this.showFilterTypeMenu(e.target, ft.dataset.columnId);
            });
        });

        const filterInputs = this.container.querySelectorAll('.filter-input');
        filterInputs.forEach(input => {
            input.addEventListener('change', (e) => {
                const colId = input.dataset.columnId;
                if (!this.filters[colId]) {
                    this.filters[colId] = { type: '^', value: '' };
                }
                this.filters[colId].value = input.value;
                this.currentPage = 0;
                this.loadData();
            });
        });

        if (this.options.onCellClick) {
            this.container.querySelectorAll('td').forEach(td => {
                td.addEventListener('click', () => {
                    const row = parseInt(td.dataset.row);
                    const col = parseInt(td.dataset.col);
                    this.options.onCellClick(row, col, this.data[row][col]);
                });
            });
        }
    }

    showFilterTypeMenu(target, columnId) {
        const column = this.columns.find(c => c.id === columnId);
        const format = column.format || 'SHORT';
        const filterGroup = this.filterTypes[format] || this.filterTypes['SHORT'];

        document.querySelectorAll('.filter-type-menu').forEach(m => m.remove());

        const menu = document.createElement('div');
        menu.className = 'filter-type-menu';
        menu.innerHTML = filterGroup.map(f => `
            <div class="filter-type-option" data-symbol="${f.symbol}">
                <span class="symbol">${f.symbol}</span>
                <span>${f.name}</span>
            </div>
        `).join('');

        const rect = target.getBoundingClientRect();
        menu.style.position = 'absolute';
        menu.style.top = rect.bottom + 'px';
        menu.style.left = rect.left + 'px';

        document.body.appendChild(menu);

        menu.querySelectorAll('.filter-type-option').forEach(opt => {
            opt.addEventListener('click', () => {
                const symbol = opt.dataset.symbol;
                if (!this.filters[columnId]) {
                    this.filters[columnId] = { type: '^', value: '' };
                }
                this.filters[columnId].type = symbol;
                target.textContent = symbol;
                menu.remove();

                if (this.filters[columnId].value) {
                    this.currentPage = 0;
                    this.loadData();
                }
            });
        });

        setTimeout(() => {
            document.addEventListener('click', function closeMenu(e) {
                if (!menu.contains(e.target) && e.target !== target) {
                    menu.remove();
                    document.removeEventListener('click', closeMenu);
                }
            });
        }, 0);
    }

    reorderColumns(draggedId, targetId) {
        const draggedIndex = this.columnOrder.indexOf(draggedId);
        const targetIndex = this.columnOrder.indexOf(targetId);

        if (draggedIndex === -1 || targetIndex === -1) return;

        this.columnOrder.splice(draggedIndex, 1);
        this.columnOrder.splice(targetIndex, 0, draggedId);

        this.saveColumnState();
        this.render();
    }

    openColumnSettings() {
        const overlay = document.createElement('div');
        overlay.className = 'column-settings-overlay';

        const modal = document.createElement('div');
        modal.className = 'column-settings-modal';
        modal.innerHTML = `
            <h5>Настройки колонок</h5>
            <div class="column-settings-list">
                ${this.columns.map(col => `
                    <div class="column-settings-item">
                        <label>
                            <input type="checkbox"
                                   data-column-id="${col.id}"
                                   ${this.visibleColumns.includes(col.id) ? 'checked' : ''}>
                            ${col.name}
                        </label>
                    </div>
                `).join('')}
            </div>
            <div style="text-align: right; margin-top: 15px;">
                <button class="btn btn-secondary" onclick="window.demoTable.closeColumnSettings()">Закрыть</button>
            </div>
        `;

        document.body.appendChild(overlay);
        document.body.appendChild(modal);

        modal.querySelectorAll('input[type="checkbox"]').forEach(cb => {
            cb.addEventListener('change', (e) => {
                const colId = cb.dataset.columnId;
                if (cb.checked) {
                    if (!this.visibleColumns.includes(colId)) {
                        this.visibleColumns.push(colId);
                    }
                } else {
                    this.visibleColumns = this.visibleColumns.filter(id => id !== colId);
                }
                this.saveColumnState();
                this.render();
            });
        });

        overlay.addEventListener('click', () => this.closeColumnSettings());
    }

    closeColumnSettings() {
        document.querySelectorAll('.column-settings-overlay, .column-settings-modal').forEach(el => el.remove());
    }

    toggleFilters() {
        this.filtersEnabled = !this.filtersEnabled;
        this.render();
    }

    nextPage() {
        this.currentPage++;
        this.loadData();
    }

    prevPage() {
        if (this.currentPage > 0) {
            this.currentPage--;
            this.loadData();
        }
    }

    saveColumnState() {
        const state = {
            order: this.columnOrder,
            visible: this.visibleColumns
        };
        document.cookie = `${this.options.cookiePrefix}-state=${JSON.stringify(state)}; path=/; max-age=31536000`;
    }

    loadColumnState() {
        const cookies = document.cookie.split(';');
        const stateCookie = cookies.find(c => c.trim().startsWith(`${this.options.cookiePrefix}-state=`));

        if (stateCookie) {
            try {
                const state = JSON.parse(stateCookie.split('=')[1]);
                this.columnOrder = state.order || [];
                this.visibleColumns = state.visible || [];
            } catch (e) {
                console.error('Error loading column state:', e);
            }
        }
    }
}

// Demo initialization with mock data
const mockData = {
    "columns": [
        {
            "id": "1",
            "type": "3596",
            "format": "CHARS",
            "name": "Задача",
            "granted": 1
        },
        {
            "id": "2",
            "type": "332",
            "format": "SHORT",
            "name": "Клиент",
            "granted": 1
        },
        {
            "id": "3",
            "type": "3942",
            "format": "NUMBER",
            "name": "ID",
            "granted": 1
        },
        {
            "id": "4",
            "type": "3884",
            "format": "SHORT",
            "name": "Статус",
            "granted": 1,
            "ref": 1
        },
        {
            "id": "5",
            "type": "3888",
            "format": "DATE",
            "name": "Срок",
            "granted": 1
        },
        {
            "id": "6",
            "type": "3597",
            "format": "BOOLEAN",
            "name": "Активна",
            "granted": 1
        }
    ],
    "data": [
        ["Настройка CRM", "ООО Рога и Копыта", 1001, "В работе", "2026-02-15", true],
        ["Консультация", "ИП Иванов", 1002, "Ожидание", "2026-02-10", true],
        ["Разработка сайта", "ООО Синтез", 1003, "Завершено", "2026-01-25", false],
        ["Аудит системы", "АО Электропочта", 1004, "В работе", "2026-02-20", true],
        ["Интеграция API", "ООО Технологии", 1005, "Новая", "2026-03-01", true],
        ["Обучение персонала", "ЗАО Инновация", 1006, "В работе", "2026-02-18", true],
        ["Миграция данных", "ООО Цифра", 1007, "Ожидание", "2026-02-12", true],
        ["Тестирование", "ИП Петров", 1008, "В работе", "2026-02-14", true]
    ],
    "total": 8
};

window.demoTable = new IntegramTable('demo-table', {
    mockData: mockData,
    pageSize: 20,
    cookiePrefix: 'demo-table',
    onCellClick: (row, col, value) => {
        console.log('Clicked cell:', { row, col, value });
    }
});
</script>

</body>
</html>
