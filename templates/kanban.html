<style>
    /* CSS Variables */
    :root {
        --primary-color: #2563eb;
        --primary-hover: #1d4ed8;
        --primary-light: #3b82f6;
        --background: #f8fafc;
        --surface: #ffffff;
        --border-color: #e2e8f0;
        --text-primary: #1e293b;
        --text-secondary: #64748b;
        --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
        --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);

        /* Status header colors - darker gradient from red to purple for better white text readability */
        --status-color-3689: #a85555;  /* Darker red - –õ–∏–¥ */
        --status-color-3689-light: #b86b6b;
        --status-color-3691: #b87355;  /* Darker red-orange - –ü–µ—Ä–≤–∏—á–Ω—ã–π –∫–æ–Ω—Ç–∞–∫—Ç */
        --status-color-3691-light: #c68565;
        --status-color-3693: #b88655;  /* Darker orange - –ö–≤–∞–ª–∏—Ñ–∏–∫–∞—Ü–∏—è */
        --status-color-3693-light: #c69865;
        --status-color-3695: #b8a555;  /* Darker yellow-orange - –û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –ö–ü */
        --status-color-3695-light: #c6b365;
        --status-color-2849: #a5b855;  /* Darker yellow - –ü—Ä–µ–∑–µ–Ω—Ç–∞—Ü–∏—è / –¥–µ–º–æ */
        --status-color-2849-light: #b3c665;
        --status-color-2843: #86b855;  /* Darker yellow-green - –°–æ–≥–ª–∞—Å–æ–≤–∞–Ω–∏–µ */
        --status-color-2843-light: #98c665;
        --status-color-2806: #55b875;  /* Darker green - –¢—Ä–∏–∞–ª / –∞–ø—Ä–æ–±–∞—Ü–∏—è */
        --status-color-2806-light: #65c686;
        --status-color-3697: #55b8a5;  /* Darker teal - –ó–∞–∫—Ä—ã—Ç–∏–µ —Å–¥–µ–ª–∫–∏ */
        --status-color-3697-light: #65c6b3;
        --status-color-3699: #5586b8;  /* Darker blue - –û–ø–ª–∞—Ç–∞ */
        --status-color-3699-light: #6598c6;
        --status-color-3701: #7355b8;  /* Darker blue-purple - –ü–æ–≤—Ç–æ—Ä–Ω–∞—è –æ–ø–ª–∞—Ç–∞ */
        --status-color-3701-light: #8565c6;
        --status-color-2824: #a555b8;  /* Darker purple - –û—Ç–∫–∞–∑ / —Å—Ä—ã–≤ —Å–¥–µ–ª–∫–∏ */
        --status-color-2824-light: #b365c6;
    }

    /* Kanban specific styles */
    .kanban-board {
        display: flex;
        gap: 16px;
        overflow-x: scroll; /* Always show horizontal scrollbar */
        padding: 10px;
        height: calc(100vh - 127px);
        align-items: flex-start;
    }

    .kanban-column {
        min-width: 300px;
        background-color: var(--surface);
        border-radius: 4px;
        box-shadow: 0 2px 1px -1px rgba(0,0,0,0.2),
                    0 1px 1px 0 rgba(0,0,0,0.14),
                    0 1px 3px 0 rgba(0,0,0,0.12);
        flex-shrink: 0;
        display: flex;
        flex-direction: column;
        height: 100%;
    }

    .kanban-column-header {
        padding: 10px;
        background: linear-gradient(135deg, var(--primary-color) 0%, var(--primary-light) 100%);
        color: white;
        font-weight: 500;
        font-size: 1rem;
        border-radius: 4px 4px 0 0;
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-shrink: 0;
        box-shadow: 0 2px 4px -1px rgba(0,0,0,0.2),
                    0 4px 5px 0 rgba(0,0,0,0.14),
                    0 1px 10px 0 rgba(0,0,0,0.12);
        position: relative;
    }

    .kanban-add-button {
        position: absolute;
        right: 50px;
        top: 50%;
        transform: translateY(-50%);
        background-color: rgba(255, 255, 255, 0.9);
        color: var(--text-primary);
        border: none;
        border-radius: 50%;
        width: 32px;
        height: 32px;
        display: none;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        font-size: 20px;
        font-weight: 600;
        transition: all 0.2s ease;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
    }

    .kanban-add-button:hover {
        background-color: white;
        transform: translateY(-50%) scale(1.1);
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
    }

    .kanban-column-header:hover .kanban-add-button {
        display: flex;
    }

    /* Status-specific header colors */
    .kanban-column-header[data-status-id="3689"] {
        background: linear-gradient(135deg, var(--status-color-3689) 0%, var(--status-color-3689-light) 100%);
    }
    .kanban-column-header[data-status-id="3691"] {
        background: linear-gradient(135deg, var(--status-color-3691) 0%, var(--status-color-3691-light) 100%);
    }
    .kanban-column-header[data-status-id="3693"] {
        background: linear-gradient(135deg, var(--status-color-3693) 0%, var(--status-color-3693-light) 100%);
    }
    .kanban-column-header[data-status-id="3695"] {
        background: linear-gradient(135deg, var(--status-color-3695) 0%, var(--status-color-3695-light) 100%);
    }
    .kanban-column-header[data-status-id="2849"] {
        background: linear-gradient(135deg, var(--status-color-2849) 0%, var(--status-color-2849-light) 100%);
    }
    .kanban-column-header[data-status-id="2843"] {
        background: linear-gradient(135deg, var(--status-color-2843) 0%, var(--status-color-2843-light) 100%);
    }
    .kanban-column-header[data-status-id="2806"] {
        background: linear-gradient(135deg, var(--status-color-2806) 0%, var(--status-color-2806-light) 100%);
    }
    .kanban-column-header[data-status-id="3697"] {
        background: linear-gradient(135deg, var(--status-color-3697) 0%, var(--status-color-3697-light) 100%);
    }
    .kanban-column-header[data-status-id="3699"] {
        background: linear-gradient(135deg, var(--status-color-3699) 0%, var(--status-color-3699-light) 100%);
    }
    .kanban-column-header[data-status-id="3701"] {
        background: linear-gradient(135deg, var(--status-color-3701) 0%, var(--status-color-3701-light) 100%);
    }
    .kanban-column-header[data-status-id="2824"] {
        background: linear-gradient(135deg, var(--status-color-2824) 0%, var(--status-color-2824-light) 100%);
    }

    .kanban-column-count {
        background-color: rgba(255, 255, 255, 0.25);
        padding: 4px 12px;
        border-radius: 16px;
        font-size: 0.875rem;
        font-weight: 500;
    }

    .kanban-column-body {
        padding: 12px;
        overflow-y: auto;
        flex: 1;
        min-height: 0;
    }

    .kanban-card {
        background-color: var(--surface);
        max-width: 322px;
        border: none;
        border-radius: 4px;
        padding: 16px;
        padding-right: 44px; /* Make space for vertical icons on the right */
        margin-bottom: 12px;
        cursor: move;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        position: relative; /* Enable absolute positioning for icons */
        box-shadow: 0 2px 1px -1px rgba(0,0,0,0.2),
                    0 1px 1px 0 rgba(0,0,0,0.14),
                    0 1px 3px 0 rgba(0,0,0,0.12);
    }

    .kanban-card:hover {
        box-shadow: 0 3px 5px -1px rgba(0,0,0,0.2),
                    0 6px 10px 0 rgba(0,0,0,0.14),
                    0 1px 18px 0 rgba(0,0,0,0.12);
        transform: translateY(-2px);
    }

    .kanban-card.dragging {
        opacity: 0.5;
        transform: rotate(2deg);
    }

    .kanban-column-body.drag-over {
        background-color: rgba(37, 99, 235, 0.1);
        border: 2px dashed var(--primary-color);
        border-radius: 8px;
    }

    .kanban-card-title-row {
        display: flex;
        align-items: center;
        gap: 6px;
        margin-bottom: 8px;
    }

    .kanban-card-title {
        font-weight: 600;
        font-size: 1rem;
        color: var(--text-primary);
        text-decoration: none;
        cursor: pointer;
        flex: 1;
    }

    .kanban-card-title:hover {
        color: var(--primary-color);
        text-decoration: underline;
    }

    .kanban-card-external-link {
        color: var(--text-secondary);
        text-decoration: none;
        font-size: 0.875rem;
        padding: 2px 4px;
        border-radius: 4px;
        transition: all 0.2s ease;
        flex-shrink: 0;
        z-index: 1;
    }

    .kanban-card-external-link:hover {
        color: var(--primary-color);
        background-color: rgba(37, 99, 235, 0.1);
    }

    .kanban-card-field {
        font-size: 0.875rem;
        color: var(--text-secondary);
        margin-bottom: 4px;
    }

    .kanban-card-field-label {
        font-weight: 500;
        color: var(--text-primary);
    }

    .kanban-card-amount {
        font-size: 1rem;
        font-weight: 600;
        color: var(--primary-color);
        margin-top: 8px;
    }

    .kanban-card-contacts {
        position: absolute;
        bottom: 8px;
        right: 8px;
        display: flex;
        flex-direction: column; /* Stack icons vertically */
        align-items: flex-end; /* Align icons to the right */
        gap: 4px; /* Smaller gap for vertical stacking */
    }

    .kanban-card-contact-icon {
        width: 28px;
        height: 28px;
        border-radius: 4px;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        text-decoration: none;
        font-size: 14px;
        box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
    }

    .kanban-card-contact-icon.active {
        background-color: rgba(25, 118, 210, 0.15);
        color: #1976d2;
        cursor: pointer;
    }

    .kanban-card-contact-icon.active:hover {
        background-color: rgba(25, 118, 210, 0.25);
        color: #1565c0;
        transform: scale(1.1);
        box-shadow: 0 2px 4px 0 rgba(0, 0, 0, 0.1);
    }

    .kanban-card-contact-icon.inactive {
        background-color: rgba(226, 232, 240, 0.5); /* More transparent gray */
        color: rgba(148, 163, 184, 0.5); /* More transparent gray text */
        cursor: not-allowed;
        pointer-events: none;
    }

    .kanban-card-date {
        font-size: 0.75rem;
        color: var(--text-secondary);
        text-align: right;
        margin-top: 4px;
    }

    .kanban-card-tasks-button {
        height: 20px;
        border-radius: 4px;
        padding: 4px 12px;
        font-size: 0.875rem;
        border: none;
        cursor: pointer;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        text-decoration: none; /* For anchor tags */
        text-transform: none;
        letter-spacing: 0.0178571429em;
    }

    .kanban-card-tasks-button.has-tasks {
        background-color: #b8a555;
        color: white;
        box-shadow: 0 2px 1px -1px rgba(0,0,0,0.2),
                    0 1px 1px 0 rgba(0,0,0,0.14),
                    0 1px 3px 0 rgba(0,0,0,0.12);
    }

    .kanban-card-tasks-button.has-tasks:hover {
        background-color: #a59449;
        transform: translateY(-1px);
        box-shadow: 0 3px 3px -2px rgba(0,0,0,0.2),
                    0 3px 4px 0 rgba(0,0,0,0.14),
                    0 1px 8px 0 rgba(0,0,0,0.12);
    }

    .kanban-card-tasks-button.no-tasks {
        background-color: rgba(0, 0, 0, 0.12);
        color: rgba(0, 0, 0, 0.38);
        cursor: default;
    }

    .kanban-card-deals-button {
        height: 20px;
        border-radius: 4px;
        padding: 4px 12px;
        font-size: 0.875rem;
        border: none;
        cursor: pointer;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        text-decoration: none; /* For anchor tags */
        text-transform: none;
        letter-spacing: 0.0178571429em;
        margin-left: 10px;
    }

    .kanban-card-deals-button.has-deals {
        background-color: #55b875;
        color: white;
        box-shadow: 0 2px 1px -1px rgba(0,0,0,0.2),
                    0 1px 1px 0 rgba(0,0,0,0.14),
                    0 1px 3px 0 rgba(0,0,0,0.12);
    }

    .kanban-card-deals-button.has-deals:hover {
        background-color: #4aa668;
        transform: translateY(-1px);
        box-shadow: 0 3px 3px -2px rgba(0,0,0,0.2),
                    0 3px 4px 0 rgba(0,0,0,0.14),
                    0 1px 8px 0 rgba(0,0,0,0.12);
    }

    .kanban-card-deals-button.no-deals {
        background-color: rgba(0, 0, 0, 0.12);
        color: rgba(0, 0, 0, 0.38);
        cursor: default;
    }

    .kanban-card-tasks-row {
        display: flex;
        align-items: center;
        gap: 2px;
        margin-top: 8px;
    }

    .kanban-add-task-button {
        width: 20px;
        height: 20px;
        border-radius: 4px;
        border: none;
        background-color: #b8a555;
        color: white;
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.2s ease;
        padding: 0;
        line-height: 1;
        box-shadow: 0 2px 1px -1px rgba(0,0,0,0.2),
                    0 1px 1px 0 rgba(0,0,0,0.14),
                    0 1px 3px 0 rgba(0,0,0,0.12);
    }

    .kanban-add-task-button:hover {
        background-color: var(--primary-hover);
        transform: scale(1.1);
        box-shadow: 0 3px 3px -2px rgba(0,0,0,0.2),
                    0 3px 4px 0 rgba(0,0,0,0.14),
                    0 1px 8px 0 rgba(0,0,0,0.12);
    }

    .kanban-add-deal-button {
        width: 20px;
        height: 20px;
        border-radius: 4px;
        border: none;
        background-color: #55b875;
        color: white;
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.2s ease;
        padding: 0;
        line-height: 1;
        box-shadow: 0 2px 1px -1px rgba(0,0,0,0.2),
                    0 1px 1px 0 rgba(0,0,0,0.14),
                    0 1px 3px 0 rgba(0,0,0,0.12);
    }

    .kanban-add-deal-button:hover {
        background-color: #4aa668;
        transform: scale(1.1);
        box-shadow: 0 3px 3px -2px rgba(0,0,0,0.2),
                    0 3px 4px 0 rgba(0,0,0,0.14),
                    0 1px 8px 0 rgba(0,0,0,0.12);
    }

    .loading {
        text-align: center;
        padding: 40px;
        color: var(--text-secondary);
    }

    .error {
        background-color: #fee2e2;
        color: #991b1b;
        padding: 16px;
        border-radius: 8px;
        margin: 20px;
    }

    /* Modal styles */
    .kanban-modal-overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
        z-index: 1000;
        align-items: center;
        justify-content: center;
    }

    .kanban-modal-overlay.active {
        display: flex;
    }

    .kanban-modal {
        background-color: var(--surface);
        border-radius: 8px;
        box-shadow: var(--shadow-lg);
        max-width: 500px;
        width: 90%;
        max-height: 90vh;
        overflow-y: auto;
    }

    .kanban-modal-header {
        padding: 20px 24px;
        border-bottom: 1px solid var(--border-color);
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .kanban-modal-title {
        font-size: 1.25rem;
        font-weight: 600;
        color: var(--text-primary);
        margin: 0;
    }

    .kanban-modal-close {
        background: none;
        border: none;
        font-size: 24px;
        color: var(--text-secondary);
        cursor: pointer;
        padding: 0;
        width: 32px;
        height: 32px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 4px;
        transition: all 0.2s ease;
    }

    .kanban-modal-close:hover {
        background-color: var(--background);
        color: var(--text-primary);
    }

    .kanban-modal-body {
        padding: 24px;
    }

    .kanban-form-group {
        position: relative;
        margin-bottom: 20px;
    }

    .kanban-form-label {
        position: absolute;
        top: -8px;
        left: 8px;
        background-color: var(--surface);
        padding: 0 4px;
        font-weight: 500;
        color: var(--text-primary);
        font-size: 0.75rem;
        z-index: 1;
    }

    .kanban-form-label.required::after {
        content: ' *';
        color: #dc3545;
    }

    .kanban-form-input,
    .kanban-form-select {
        width: 100%;
        padding: 12px 12px 8px 12px;
        border: 1px solid var(--border-color);
        border-radius: 6px;
        font-size: 0.875rem;
        transition: all 0.2s ease;
    }

    .kanban-form-input:focus,
    .kanban-form-select:focus {
        outline: none;
        border-color: var(--primary-color);
        box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
    }

    .kanban-form-input.error,
    .kanban-form-select.error {
        border-color: #dc3545;
    }

    .kanban-form-static {
        padding: 8px 12px;
        background-color: var(--background);
        border-radius: 6px;
        color: var(--text-secondary);
        font-size: 0.875rem;
    }

    .kanban-modal-footer {
        padding: 16px 24px;
        border-top: 1px solid var(--border-color);
        display: flex;
        justify-content: flex-end;
        gap: 12px;
    }

    .kanban-button {
        padding: 8px 16px;
        border-radius: 6px;
        font-weight: 500;
        font-size: 0.875rem;
        cursor: pointer;
        transition: all 0.2s ease;
        border: none;
    }

    .kanban-button-primary {
        background-color: var(--primary-color);
        color: white;
    }

    .kanban-button-primary:hover {
        background-color: var(--primary-hover);
        transform: translateY(-1px);
        box-shadow: var(--shadow-sm);
    }

    .kanban-button-primary:disabled {
        background-color: var(--text-secondary);
        cursor: not-allowed;
        transform: none;
    }

    .kanban-button-secondary {
        background-color: var(--background);
        color: var(--text-primary);
    }

    .kanban-button-secondary:hover {
        background-color: var(--border-color);
    }

    /* Control panel styles */
    .kanban-controls {
        background-color: var(--surface);
        padding: 10px;
        box-shadow: var(--shadow-sm);
        display: flex;
        align-items: center;
        gap: 12px;
        flex-wrap: wrap;
    }

    .kanban-control-group {
        display: flex;
        align-items: center;
        gap: 12px;
        min-height: 38px;
    }

    .kanban-control-label {
        font-weight: 500;
        color: var(--text-primary);
        font-size: 0.875rem;
        align-self: center;
    }

    /* Quick search input styles */
    .kanban-search-input {
        padding: 6px 12px;
        border: 1px solid var(--border-color);
        border-radius: 6px;
        font-size: 0.75rem;
        width: 210px;
        transition: all 0.2s ease;
        background-color: var(--surface);
        color: var(--text-primary);
    }

    .kanban-search-input:focus {
        outline: none;
        border-color: var(--primary-color);
        box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
    }

    .kanban-search-input::placeholder {
        color: var(--text-secondary);
    }

    /* Toggle switch styles */
    .kanban-toggle {
        display: inline-flex;
        background-color: var(--background);
        border-radius: 6px;
        padding: 2px;
        gap: 2px;
    }

    .kanban-toggle-option {
        padding: 6px 16px;
        border-radius: 4px;
        cursor: pointer;
        transition: all 0.2s ease;
        font-size: 0.875rem;
        font-weight: 500;
        color: var(--text-secondary);
        background-color: transparent;
        border: none;
        white-space: nowrap;
    }

    .kanban-toggle-option:hover {
        color: var(--text-primary);
    }

    .kanban-toggle-option.active {
        background-color: var(--primary-color);
        color: white;
        box-shadow: var(--shadow-sm);
    }

    /* Radio button styles */
    .kanban-radio-group {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
    }

    .kanban-radio-label {
        display: inline-flex;
        align-items: center;
        cursor: pointer;
        padding: 6px 12px;
        border-radius: 6px;
        border: 1px solid var(--border-color);
        background-color: var(--surface);
        font-size: 0.875rem;
        transition: all 0.2s ease;
        white-space: nowrap;
        margin-bottom: 0;
    }

    .kanban-radio-label:hover {
        border-color: var(--primary-color);
        background-color: var(--background);
    }

    .kanban-radio-label input[type="radio"] {
        margin-right: 6px;
        cursor: pointer;
    }

    .kanban-radio-label input[type="radio"]:checked + span {
        font-weight: 600;
        color: var(--primary-color);
    }

    .kanban-radio-label:has(input[type="radio"]:checked) {
        border-color: var(--primary-color);
        background-color: rgba(37, 99, 235, 0.05);
    }

    /* Manager select dropdown */
    .kanban-select {
        padding: 6px 12px;
        border-radius: 6px;
        border: 1px solid var(--border-color);
        background-color: var(--surface);
        font-size: 0.875rem;
        color: var(--text-primary);
        cursor: pointer;
        transition: all 0.2s ease;
        min-width: 150px;
    }

    .kanban-select:hover {
        border-color: var(--primary-color);
        background-color: var(--background);
    }

    .kanban-select:focus {
        outline: none;
        border-color: var(--primary-color);
        box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
    }

    /* Edit form modal styles */
    .kanban-edit-modal-overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
        z-index: 1001;
        align-items: center;
        justify-content: center;
    }

    .kanban-edit-modal-overlay.active {
        display: flex;
    }

    .kanban-edit-modal {
        background-color: var(--surface);
        border-radius: 8px;
        box-shadow: var(--shadow-lg);
        max-width: 600px;
        width: 90%;
        max-height: 90vh;
        display: flex;
        flex-direction: column;
    }

    .kanban-edit-modal-header {
        padding: 16px 24px;
        border-bottom: 1px solid var(--border-color);
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-shrink: 0;
    }

    .kanban-edit-modal-title {
        font-size: 1.125rem;
        font-weight: 600;
        color: var(--text-primary);
        margin: 0;
    }

    .kanban-edit-modal-close {
        background: none;
        border: none;
        font-size: 24px;
        color: var(--text-secondary);
        cursor: pointer;
        padding: 0;
        width: 32px;
        height: 32px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 4px;
        transition: all 0.2s ease;
    }

    .kanban-edit-modal-close:hover {
        background-color: var(--background);
        color: var(--text-primary);
    }

    .kanban-edit-modal-body {
        padding: 24px;
        overflow-y: auto;
        flex: 1;
    }

    .kanban-edit-modal-footer {
        padding: 16px 24px;
        border-top: 1px solid var(--border-color);
        display: flex;
        justify-content: flex-end;
        gap: 12px;
        flex-shrink: 0;
    }

    .kanban-edit-form-group {
        margin-bottom: 16px;
    }

    .kanban-edit-form-label {
        display: block;
        font-weight: 500;
        color: var(--text-primary);
        font-size: 0.875rem;
        margin-bottom: 6px;
    }

    .kanban-edit-form-label.required::after {
        content: ' *';
        color: #dc3545;
    }

    .kanban-edit-form-input,
    .kanban-edit-form-select,
    .kanban-edit-form-textarea {
        width: 100%;
        padding: 10px 12px;
        border: 1px solid var(--border-color);
        border-radius: 6px;
        font-size: 0.875rem;
        transition: all 0.2s ease;
        background-color: var(--surface);
    }

    .kanban-edit-form-textarea {
        resize: vertical;
        min-height: 80px;
    }

    .kanban-edit-form-input:focus,
    .kanban-edit-form-select:focus,
    .kanban-edit-form-textarea:focus {
        outline: none;
        border-color: var(--primary-color);
        box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
    }

    .kanban-edit-form-input.error,
    .kanban-edit-form-select.error,
    .kanban-edit-form-textarea.error {
        border-color: #dc3545;
    }

    .kanban-edit-loading {
        text-align: center;
        padding: 40px;
        color: var(--text-secondary);
    }
</style>

<!-- Control panel above kanban -->
<div class="kanban-controls">
    <div class="kanban-control-group">
        <input type="text" id="quickSearch" class="kanban-search-input" placeholder="–ë—ã—Å—Ç—Ä—ã–π –ø–æ–∏—Å–∫" oninput="performQuickSearch()">
    </div>
    <div class="kanban-control-group">
        <div class="kanban-toggle">
            <button class="kanban-toggle-option" id="toggleSales" onclick="setFilterType('sales')">–ü—Ä–æ–¥–∞–∂–∏</button>
            <button class="kanban-toggle-option" id="togglePartners" onclick="setFilterType('partners')">–ü–∞—Ä—Ç–Ω–µ—Ä—ã</button>
        </div>
    </div>
    <div class="kanban-control-group">
        <select id="managerSelect" class="kanban-select" onchange="onManagerChange()">
            <!-- Will be populated dynamically -->
        </select>
    </div>
    <div class="kanban-control-group">
        <span class="kanban-control-label">–ü—Ä–æ–¥—É–∫—Ç:</span>
        <div class="kanban-radio-group" id="productRadioGroup">
            <!-- Will be populated dynamically -->
        </div>
    </div>
</div>

<div id="kanban"></div>

<!-- Modal for adding new record -->
<div id="addRecordModal" class="kanban-modal-overlay">
    <div class="kanban-modal">
        <div class="kanban-modal-header">
            <h3 class="kanban-modal-title">–î–æ–±–∞–≤–∏—Ç—å –∑–∞–ø–∏—Å—å</h3>
            <button class="kanban-modal-close" onclick="closeAddRecordModal()">&times;</button>
        </div>
        <div class="kanban-modal-body">
            <form id="addRecordForm">
                <div class="kanban-form-group">
                    <label class="kanban-form-label required">–ù–∞–∑–≤–∞–Ω–∏–µ</label>
                    <input type="text" class="kanban-form-input" id="recordName" name="recordName">
                </div>
                <div class="kanban-form-group">
                    <label class="kanban-form-label">–ò–ù–ù</label>
                    <input type="text" class="kanban-form-input" id="recordInn" name="recordInn">
                </div>
                <div class="kanban-form-group">
                    <label class="kanban-form-label">–°—Ç–∞—Ç—É—Å</label>
                    <div class="kanban-form-static" id="recordStatus"></div>
                </div>
                <div class="kanban-form-group">
                    <label class="kanban-form-label required">–ü–∞—Ä—Ç–Ω–µ—Ä</label>
                    <select class="kanban-form-select" id="recordPartner" name="recordPartner">
                        <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –ø–∞—Ä—Ç–Ω–µ—Ä–∞</option>
                    </select>
                </div>
                <div class="kanban-form-group">
                    <label class="kanban-form-label">–î–∏—Å—Ç—Ä–∏–±—å—é—Ç–æ—Ä</label>
                    <select class="kanban-form-select" id="recordDistributor" name="recordDistributor">
                        <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –¥–∏—Å—Ç—Ä–∏–±—å—é—Ç–æ—Ä–∞</option>
                    </select>
                </div>
                <div class="kanban-form-group">
                    <label class="kanban-form-label required">–¢–µ–ª–µ—Ñ–æ–Ω</label>
                    <input type="text" class="kanban-form-input" id="recordPhone" name="recordPhone">
                </div>
                <div class="kanban-form-group">
                    <label class="kanban-form-label required">Email</label>
                    <input type="email" class="kanban-form-input" id="recordEmail" name="recordEmail">
                </div>
                <div class="kanban-form-group">
                    <label class="kanban-form-label">–ö–æ–Ω—Ç–∞–∫—Ç–Ω–æ–µ –ª–∏—Ü–æ</label>
                    <input type="text" class="kanban-form-input" id="recordContact" name="recordContact">
                </div>
                <div class="kanban-form-group">
                    <label class="kanban-form-label required">–ò—Å—Ç–æ—á–Ω–∏–∫</label>
                    <select class="kanban-form-select" id="recordSource" name="recordSource">
                        <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –∏—Å—Ç–æ—á–Ω–∏–∫</option>
                    </select>
                </div>
                <div class="kanban-form-group">
                    <label class="kanban-form-label">–°—É–º–º–∞</label>
                    <input type="number" class="kanban-form-input" id="recordAmount" name="recordAmount">
                </div>
            </form>
        </div>
        <div class="kanban-modal-footer">
            <button class="kanban-button kanban-button-primary" onclick="submitAddRecord()" id="submitButton">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
            <button class="kanban-button kanban-button-secondary" onclick="closeAddRecordModal()">–û—Ç–º–µ–Ω–∞</button>
        </div>
    </div>
</div>

<!-- Modal for editing client -->
<!-- Client edit modal - will be replaced with IntegramTable form -->
<div id="editClientModal" class="kanban-edit-modal-overlay">
    <div class="kanban-edit-modal">
        <div class="kanban-edit-modal-body" id="editClientModalBody">
            <div class="kanban-edit-loading">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
        </div>
    </div>
</div>

<!-- Modal for creating task -->
<div id="createTaskModal" class="kanban-edit-modal-overlay">
    <div class="kanban-edit-modal">
        <div class="kanban-edit-modal-header">
            <h3 class="kanban-edit-modal-title">–î–æ–±–∞–≤–∏—Ç—å –∑–∞–¥–∞—á—É</h3>
            <button class="kanban-edit-modal-close" onclick="closeTaskCreateModal()">&times;</button>
        </div>
        <div class="kanban-edit-modal-body" id="createTaskModalBody">
            <div class="kanban-edit-loading">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
        </div>
        <div class="kanban-edit-modal-footer">
            <button class="kanban-button kanban-button-primary" onclick="submitCreateTask()" id="createTaskSubmitButton">–°–æ–∑–¥–∞—Ç—å</button>
            <button class="kanban-button kanban-button-secondary" onclick="closeTaskCreateModal()">–û—Ç–º–µ–Ω–∞</button>
        </div>
    </div>
</div>

<!-- Modal for creating deal -->
<div id="createDealModal" class="kanban-edit-modal-overlay">
    <div class="kanban-edit-modal">
        <div class="kanban-edit-modal-header">
            <h3 class="kanban-edit-modal-title">–î–æ–±–∞–≤–∏—Ç—å —Å–¥–µ–ª–∫—É</h3>
            <button class="kanban-edit-modal-close" onclick="closeDealCreateModal()">&times;</button>
        </div>
        <div class="kanban-edit-modal-body" id="createDealModalBody">
            <div class="kanban-edit-loading">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
        </div>
        <div class="kanban-edit-modal-footer">
            <button class="kanban-button kanban-button-primary" onclick="submitCreateDeal()" id="createDealSubmitButton">–°–æ–∑–¥–∞—Ç—å</button>
            <button class="kanban-button kanban-button-secondary" onclick="closeDealCreateModal()">–û—Ç–º–µ–Ω–∞</button>
        </div>
    </div>
</div>

<script>
// Kanban functionality
var kanbanData = [];
var statusesData = [];
var editFormStatusesData = []; // Statuses for edit form (all statuses, unfiltered)
var sourcesData = [];
var distributorsData = [];
var partnersData = [];
var productsData = [];
var managersData = [];
var taskTypesData = [];
var currentStatusId = null;
var currentStatusName = null;
var currentFilterType = 'sales'; // 'sales' or 'partners'
var currentProductId = 'all'; // 'all' or specific product ID
var currentManagerId = null; // Selected manager ID, defaults to window.uid
var searchQuery = ''; // Quick search query
// Check if there's a saved manager ID in cookie
var savedManagerId = getCookie('kanban_manager_id');
currentManagerId = savedManagerId;

console.log('populateManagerSelect '+savedManagerId);
populateManagerSelect();

// Cookie management functions
function setCookie(name, value, days) {
    var expires = "";
    if (days) {
        var date = new Date();
        date.setTime(date.getTime() + (days * 24 * 60 * 60 * 1000));
        expires = "; expires=" + date.toUTCString();
    }
    document.cookie = name + "=" + (value || "") + expires + "; path=/";
}

function getCookie(name) {
    var nameEQ = name + "=";
    var ca = document.cookie.split(';');
    for (var i = 0; i < ca.length; i++) {
        var c = ca[i];
        while (c.charAt(0) == ' ') c = c.substring(1, c.length);
        if (c.indexOf(nameEQ) == 0) return c.substring(nameEQ.length, c.length);
    }
    return null;
}

// Set filter type (sales/partners)
function setFilterType(type) {
    currentFilterType = type;
    setCookie('kanban_filter_type', type, 365);

    // Update toggle UI
    $('#toggleSales').toggleClass('active', type === 'sales');
    $('#togglePartners').toggleClass('active', type === 'partners');

    // Reload kanban data
    loadKanbanData();
}

// Set product filter
function setProductFilter(productId) {
    currentProductId = productId;
    setCookie('kanban_product_id', productId, 365);

    // Reload kanban data
    loadKanbanData();
}

// Handle manager selection change
function onManagerChange() {
    var select = document.getElementById('managerSelect');
    currentManagerId = select.value;
    setCookie('kanban_manager_id', currentManagerId, 365);

    // Reload kanban data
    loadKanbanData();
}

// Quick search function
function performQuickSearch() {
    searchQuery = document.getElementById('quickSearch').value.toLowerCase().trim();
    renderKanban();
}

// Load products list
function loadProductsList() {
    var xhr = new XMLHttpRequest();
    xhr.open('GET', 'https://' + window.location.hostname + '/' + db + '/report/5172?JSON_KV', true);
    xhr.onload = function() {
        if (xhr.status === 200) {
            try {
                productsData = JSON.parse(xhr.responseText);
                populateProductRadios();
            } catch (e) {
                console.error('Error parsing products data:', e);
            }
        } else {
            console.error('Error loading products:', xhr.status);
        }
    };
    xhr.onerror = function() {
        console.error('Network error loading products');
    };
    xhr.send();
}

// Populate product radio buttons
function populateProductRadios() {
    var radioGroup = $('#productRadioGroup');
    radioGroup.empty();

    // Add "–í—Å–µ" option
    var allLabel = $('<label class="kanban-radio-label"></label>');
    var allRadio = $('<input type="radio" name="product" value="all">');
    var allText = $('<span>–í—Å–µ</span>');

    if (currentProductId === 'all') {
        allRadio.prop('checked', true);
    }

    allRadio.on('change', function() {
        if (this.checked) {
            setProductFilter('all');
        }
    });

    allLabel.append(allRadio).append(allText);
    radioGroup.append(allLabel);

    // Add individual product options
    productsData.forEach(function(product) {
        var label = $('<label class="kanban-radio-label"></label>');
        var radio = $('<input type="radio" name="product" value="' + product['–ü—Ä–æ–¥—É–∫—ÇID'] + '">');
        var text = $('<span>' + product['–ü—Ä–æ–¥—É–∫—Ç'] + '</span>');

        if (currentProductId === product['–ü—Ä–æ–¥—É–∫—ÇID']) {
            radio.prop('checked', true);
        }

        radio.on('change', function() {
            if (this.checked) {
                setProductFilter(product['–ü—Ä–æ–¥—É–∫—ÇID']);
            }
        });

        label.append(radio).append(text);
        radioGroup.append(label);
    });
}

// Restore user preferences from cookies
function restoreUserPreferences() {
    var savedFilterType = getCookie('kanban_filter_type');
    var savedProductId = getCookie('kanban_product_id');

    if (savedFilterType) {
        currentFilterType = savedFilterType;
    }

    if (savedProductId) {
        currentProductId = savedProductId;
    }

    // Update toggle UI
    $('#toggleSales').toggleClass('active', currentFilterType === 'sales');
    $('#togglePartners').toggleClass('active', currentFilterType === 'partners');
}

// Helper function to lighten a color by a percentage
function lightenColor(color, percent) {
    // Handle hex colors (e.g., #a85555)
    if (color.startsWith('#')) {
        var num = parseInt(color.slice(1), 16);
        var r = (num >> 16) + Math.round(2.55 * percent);
        var g = ((num >> 8) & 0x00FF) + Math.round(2.55 * percent);
        var b = (num & 0x0000FF) + Math.round(2.55 * percent);

        // Ensure values stay within 0-255 range
        r = Math.min(255, r);
        g = Math.min(255, g);
        b = Math.min(255, b);

        return '#' + ((r << 16) | (g << 8) | b).toString(16).padStart(6, '0');
    }

    // Handle rgb/rgba colors
    if (color.startsWith('rgb')) {
        var matches = color.match(/\d+/g);
        if (matches && matches.length >= 3) {
            var r = Math.min(255, parseInt(matches[0]) + Math.round(2.55 * percent));
            var g = Math.min(255, parseInt(matches[1]) + Math.round(2.55 * percent));
            var b = Math.min(255, parseInt(matches[2]) + Math.round(2.55 * percent));

            if (matches.length === 4) {
                return 'rgba(' + r + ', ' + g + ', ' + b + ', ' + matches[3] + ')';
            }
            return 'rgb(' + r + ', ' + g + ', ' + b + ')';
        }
    }

    // If color format is not recognized, return original color
    return color;
}

function loadKanbanData(){
    $('#kanban').html('<div class="loading">–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –∫–∞–Ω–±–∞–Ω–∞...</div>');

    // Use fixed report IDs
    var tasksReportId = '3769';
    var statusesReportId = '3796';

    // Build FR_partners parameter based on current filter type
    var frPartnersValue = currentFilterType === 'partners' ? '%25' : '!%25';

    // Build FR_product parameter if a specific product is selected
    var productParam = '';
    if (currentProductId !== 'all') {
        productParam = '&FR_product=' + encodeURIComponent(currentProductId);
    }

    // Build FR_manager parameter - always pass it
    var managerParam = '&FR_manager=' + encodeURIComponent(currentManagerId || '');
console.log('loadKanbanData');

    // Load tasks
    var xhr1 = new XMLHttpRequest();
    xhr1.open('GET', 'https://' + window.location.hostname + '/' + db + '/report/' + tasksReportId + '?JSON_KV&FR_partners=' + frPartnersValue + productParam + managerParam, true);
    xhr1.onload = function(){
        if(xhr1.status === 200){
            try{
                kanbanData = JSON.parse(xhr1.responseText);
                checkDataLoaded();
            } catch(e){
                showError('–û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ –¥–∞–Ω–Ω—ã—Ö –∑–∞–¥–∞—á: ' + e.message);
            }
        } else {
            showError('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∑–∞–¥–∞—á: ' + xhr1.status);
        }
    };
    xhr1.onerror = function(){
        showError('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –∑–∞–¥–∞—á');
    };
    xhr1.send();

    // Load statuses
    var xhr2 = new XMLHttpRequest();
    xhr2.open('GET', 'https://' + window.location.hostname + '/' + db + '/report/' + statusesReportId + '?JSON_KV&FR_partners=' + frPartnersValue + productParam + managerParam, true);
    xhr2.onload = function(){
        if(xhr2.status === 200){
            try{
                statusesData = JSON.parse(xhr2.responseText);
                checkDataLoaded();
            } catch(e){
                showError('–û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ –¥–∞–Ω–Ω—ã—Ö —Å—Ç–∞—Ç—É—Å–æ–≤: ' + e.message);
            }
        } else {
            showError('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç–∞—Ç—É—Å–æ–≤: ' + xhr2.status);
        }
    };
    xhr2.onerror = function(){
        showError('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç–∞—Ç—É—Å–æ–≤');
    };
    xhr2.send();
}

function checkDataLoaded(){
    // Render kanban if we have statuses data, even if kanbanData is empty
    if(statusesData.length > 0){
        renderKanban();
    }
}

function showError(message){
    $('#kanban').html('<div class="error">' + message + '</div>');
}

function renderKanban(){
    var html = '<div class="kanban-board">';

    // Create a column for each status
    statusesData.forEach(function(status){
        var statusName = status['–°—Ç–∞—Ç—É—Å'];
        var statusId = status['–°—Ç–∞—Ç—É—ÅID'];

        // Filter tasks for this status
        // Use flexible matching to handle cases where –°—Ç–∞—Ç—É—ÅID might contain the status name instead of ID
        var tasks = kanbanData.filter(function(task){
            // First check if task matches status
            var matchesStatus = false;
            // Try matching by –°—Ç–∞—Ç—É—ÅID (numeric ID or string ID)
            if(task['–°—Ç–∞—Ç—É—ÅID'] === statusId){
                matchesStatus = true;
            }
            // Fallback: if task's –°—Ç–∞—Ç—É—ÅID contains the status name, match by name
            if(task['–°—Ç–∞—Ç—É—ÅID'] === statusName){
                matchesStatus = true;
            }
            // Also try matching task's –°—Ç–∞—Ç—É—Å with status's –°—Ç–∞—Ç—É—Å as a final fallback
            if(task['–°—Ç–∞—Ç—É—Å'] && task['–°—Ç–∞—Ç—É—Å'] === statusName){
                matchesStatus = true;
            }

            if(!matchesStatus) return false;

            // If there's a search query, filter by all fields
            if(searchQuery && searchQuery !== ''){
                var searchableText = [
                    task['–õ–∏–¥'] || '',
                    task['–ö–æ–Ω—Ç–∞–∫—Ç–Ω–æ–µ –ª–∏—Ü–æ'] || '',
                    task['–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ'] || '',
                    task['–°—É–º–º–∞'] || '',
                    task['–¢–µ–ª–µ—Ñ–æ–Ω'] || '',
                    task['Email'] || '',
                    task['–î–∞—Ç–∞'] || ''
                ].join(' ').toLowerCase();

                return searchableText.indexOf(searchQuery) !== -1;
            }

            return true;
        });

        // Calculate total sum for this status
        var totalSum = 0;
        tasks.forEach(function(task){
            if(task['–°—É–º–º–∞']){
                // Remove spaces and convert to number
                var sumStr = task['–°—É–º–º–∞'].replace(/\s/g, '');
                var sum = parseFloat(sumStr);
                if(!isNaN(sum)){
                    totalSum += sum;
                }
            }
        });

        // Format sum with spaces as thousand separators
        var formattedSum = totalSum.toLocaleString('ru-RU');

        html += '<div class="kanban-column">';

        // Check if status has a color field and use it for the header
        var headerStyle = '';
        if(status['color']){
            // Use the color from API if available
            // Generate a lighter version of the color for the gradient by increasing brightness
            var baseColor = status['color'];
            var lightColor = lightenColor(baseColor, 8); // Lighten by 8% to match existing gradient style
            headerStyle = ' style="background: linear-gradient(135deg, ' + baseColor + ' 0%, ' + lightColor + ' 100%);"';
        }

        html += '<div class="kanban-column-header" data-status-id="' + statusId + '" data-status-name="' + statusName + '"' + headerStyle + '>';
        // Truncate status name to 28 characters with '...' if longer
        var displayStatusName = statusName.length > 28 ? statusName.substring(0, 28) + '...' : statusName;
        html += '<span title="' + statusName + '">' + displayStatusName + ' (' + formattedSum + ' ‚ÇΩ)</span>';
        html += '<button class="kanban-add-button" onclick="openAddRecordModal(\'' + statusId + '\', \'' + statusName.replace(/'/g, "\\'") + '\')">+</button>';
        html += '<span class="kanban-column-count">' + tasks.length + '</span>';
        html += '</div>';
        html += '<div class="kanban-column-body" data-status-id="' + statusId + '">';

        // Render tasks in this column
        tasks.forEach(function(task){
            html += renderCard(task);
        });

        html += '</div>';
        html += '</div>';
    });

    html += '</div>';
    $('#kanban').html(html);

    // Initialize drag and drop
    initDragAndDrop();
}

function renderCard(task){
    var html = '<div class="kanban-card" draggable="true" data-lead-id="' + task['–õ–∏–¥ID'] + '" data-status-id="' + task['–°—Ç–∞—Ç—É—ÅID'] + '">';

    // Create title as clickable element to open inline edit form
    var editUrl = '/' + db + '/edit_obj/' + task['–õ–∏–¥ID'];
    html += '<div class="kanban-card-title-row">';
    html += '<span class="kanban-card-title" onclick="openClientEditForm(\'' + task['–õ–∏–¥ID'] + '\'); event.stopPropagation();">' + (task['–õ–∏–¥'] || '') + '</span>';
    html += '<a target="eo" href="' + editUrl + '" class="kanban-card-external-link" onclick="event.stopPropagation();" title="–û—Ç–∫—Ä—ã—Ç—å –≤ –Ω–æ–≤–æ–º –æ–∫–Ω–µ">‚Üó</a>';
    html += '</div>';

    if(task['–ö–æ–Ω—Ç–∞–∫—Ç–Ω–æ–µ –ª–∏—Ü–æ']){
        html += '<div class="kanban-card-field"><span class="kanban-card-field-label">–ö–æ–Ω—Ç–∞–∫—Ç:</span> ' + task['–ö–æ–Ω—Ç–∞–∫—Ç–Ω–æ–µ –ª–∏—Ü–æ'] + '</div>';
    }

    if(task['–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ']){
        html += '<div class="kanban-card-field"><span class="kanban-card-field-label">–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ:</span> ' + task['–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ'] + '</div>';
    }

    if(task['–°—É–º–º–∞']){
        html += '<div class="kanban-card-amount">' + task['–°—É–º–º–∞'] + ' ‚ÇΩ</div>';
    }

    // Add contact icons at bottom right (vertically stacked)
    html += '<div class="kanban-card-contacts">';

    // Phone icon (on top)
    var hasPhone = task['–¢–µ–ª–µ—Ñ–æ–Ω'] && task['–¢–µ–ª–µ—Ñ–æ–Ω'].trim() !== '';
    if(hasPhone){
        html += '<span class="kanban-card-contact-icon active" title="' + task['–¢–µ–ª–µ—Ñ–æ–Ω'] + '" onclick="copyContact(\'' + task['–¢–µ–ª–µ—Ñ–æ–Ω'] + '\', \'phone\', event)">üìû</span>';
    } else {
        html += '<span class="kanban-card-contact-icon inactive" title="–¢–µ–ª–µ—Ñ–æ–Ω –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω">üìû</span>';
    }

    // Email icon (below)
    var hasEmail = task['Email'] && task['Email'].trim() !== '';
    if(hasEmail){
        html += '<span class="kanban-card-contact-icon active" title="' + task['Email'] + '" onclick="copyContact(\'' + task['Email'] + '\', \'email\', event)">üìß</span>';
    } else {
        html += '<span class="kanban-card-contact-icon inactive" title="Email –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω">üìß</span>';
    }

    // Date below contact icons (without "–î–∞—Ç–∞:" label)
    if(task['–î–∞—Ç–∞']){
        html += '<div class="kanban-card-date">' + task['–î–∞—Ç–∞'] + '</div>';
    }

    html += '</div>';

    // Add tasks badge with "+" button at the bottom of the card
    var tasksCount = task['–ó–∞–¥–∞—á–∏'] ? parseInt(task['–ó–∞–¥–∞—á–∏']) : 0;
    var buttonClass = tasksCount > 0 ? 'has-tasks' : 'no-tasks';

    // Use fixed FR parameter
    var tasksUrl = '';
    if(task['–õ–∏–¥ID']){
        tasksUrl = '/' + db + '/object/3596?FR_4547=@' + task['–õ–∏–¥ID'];
    }

    html += '<div class="kanban-card-tasks-row">';
    if(tasksCount > 0 && tasksUrl){
        html += '<a href="' + tasksUrl + '" target="tasks" class="kanban-card-tasks-button ' + buttonClass + '" data-lead-id="' + task['–õ–∏–¥ID'] + '" onclick="event.stopPropagation();">';
        html += '–ó–∞–¥–∞—á–∏:&nbsp;<span class="tasks-count">' + tasksCount + '</span>';
        html += '</a>';
    } else {
        html += '<span class="kanban-card-tasks-button ' + buttonClass + '" data-lead-id="' + task['–õ–∏–¥ID'] + '">';
        html += '–ó–∞–¥–∞—á–∏:&nbsp;<span class="tasks-count">' + tasksCount + '</span>';
        html += '</span>';
    }
    html += '<button class="kanban-add-task-button" onclick="openTaskCreateForm(\'' + task['–õ–∏–¥ID'] + '\', this); event.stopPropagation();" title="–î–æ–±–∞–≤–∏—Ç—å –∑–∞–¥–∞—á—É">+</button>';

    // Add deals badge next to tasks badge
    var dealsCount = task['–°–¥–µ–ª–æ–∫'] ? parseInt(task['–°–¥–µ–ª–æ–∫']) : 0;
    var dealsButtonClass = dealsCount > 0 ? 'has-deals' : 'no-deals';
    var dealsUrl = '';
    if(task['–õ–∏–¥ID']){
        dealsUrl = '/' + db + '/smartq/6271?FR_–ö–ª–∏–µ–Ω—ÇID=' + task['–õ–∏–¥ID'];
    }

    if(dealsCount > 0 && dealsUrl){
        html += '<a href="' + dealsUrl + '" target="deals" class="kanban-card-deals-button ' + dealsButtonClass + '" data-lead-id="' + task['–õ–∏–¥ID'] + '" onclick="event.stopPropagation();">';
        html += '–°–¥–µ–ª–∫–∏:&nbsp;<span class="deals-count">' + dealsCount + '</span>';
        html += '</a>';
    } else {
        html += '<span class="kanban-card-deals-button ' + dealsButtonClass + '" data-lead-id="' + task['–õ–∏–¥ID'] + '">';
        html += '–°–¥–µ–ª–∫–∏:&nbsp;<span class="deals-count">' + dealsCount + '</span>';
        html += '</span>';
    }
    html += '<button class="kanban-add-deal-button" onclick="openDealCreateForm(\'' + task['–õ–∏–¥ID'] + '\', this); event.stopPropagation();" title="–î–æ–±–∞–≤–∏—Ç—å —Å–¥–µ–ª–∫—É">+</button>';

    html += '</div>';

    html += '</div>';
    return html;
}

function initDragAndDrop(){
    var draggedElement = null;
    var scrollInterval = null;

    // Handle drag start
    $(document).on('dragstart', '.kanban-card', function(e){
        draggedElement = this;
        $(this).addClass('dragging');
        e.originalEvent.dataTransfer.effectAllowed = 'move';
        e.originalEvent.dataTransfer.setData('text/html', this.innerHTML);
    });

    // Handle drag end
    $(document).on('dragend', '.kanban-card', function(e){
        $(this).removeClass('dragging');
        $('.kanban-column-body').removeClass('drag-over');
        // Clear scroll interval
        if(scrollInterval) {
            clearInterval(scrollInterval);
            scrollInterval = null;
        }
    });

    // Handle drag over with auto-scroll
    $(document).on('dragover', '.kanban-column-body', function(e){
        if(e.preventDefault){
            e.preventDefault();
        }
        e.originalEvent.dataTransfer.dropEffect = 'move';
        $(this).addClass('drag-over');

        // Auto-scroll kanban board based on mouse position
        var board = $('.kanban-board')[0];
        var clientX = e.originalEvent.clientX;
        var boardRect = board.getBoundingClientRect();
        var scrollThreshold = 50;

        // Clear existing scroll interval
        if(scrollInterval) clearInterval(scrollInterval);

        // Scroll left if near left edge
        if(clientX < boardRect.left + scrollThreshold){
            scrollInterval = setInterval(function(){
                board.scrollLeft -= 10;
            }, 20);
        }
        // Scroll right if near right edge
        else if(clientX > boardRect.right - scrollThreshold){
            scrollInterval = setInterval(function(){
                board.scrollLeft += 10;
            }, 20);
        }

        return false;
    });

    // Handle drag enter
    $(document).on('dragenter', '.kanban-column-body', function(e){
        $(this).addClass('drag-over');
    });

    // Handle drag leave
    $(document).on('dragleave', '.kanban-column-body', function(e){
        $(this).removeClass('drag-over');
        // Clear scroll interval when leaving all column bodies
        var anyDragOver = $('.kanban-column-body.drag-over').length > 0;
        if(!anyDragOver && scrollInterval) {
            clearInterval(scrollInterval);
            scrollInterval = null;
        }
    });

    // Handle drop
    $(document).on('drop', '.kanban-column-body', function(e){
        if(e.stopPropagation){
            e.stopPropagation();
        }
        $(this).removeClass('drag-over');

        if(draggedElement){
            var newStatusId = $(this).data('status-id');
            var oldStatusId = $(draggedElement).data('status-id');
            var leadId = $(draggedElement).data('lead-id');

            // Only update if status changed
            if(newStatusId !== oldStatusId){
                // Move card visually
                $(this).append(draggedElement);
                $(draggedElement).data('status-id', newStatusId);

                // Update counts
                updateColumnCounts();

                // Update via API
                updateTaskStatus(leadId, newStatusId);
            }
        }

        return false;
    });
}

function updateColumnCounts(){
    $('.kanban-column').each(function(){
        var count = $(this).find('.kanban-card').length;
        $(this).find('.kanban-column-count').text(count);
    });
}

function updateTaskStatus(leadId, newStatusId){
    var timestamp = Math.floor(Date.now() / 1000);
    var xhr = new XMLHttpRequest();
    xhr.open('POST', 'https://' + window.location.hostname + '/' + db + '/_m_set/' + leadId + '?JSON', true);
    xhr.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');
    xhr.onload = function(){
        if(xhr.status === 200){
            try{
                var response = JSON.parse(xhr.responseText);
                console.log('Status updated:', response);
            } catch(e){
                console.error('Error parsing response:', e);
            }
        } else {
            console.error('Error updating status:', xhr.status);
        }
    };
    xhr.onerror = function(){
        console.error('Network error updating status');
    };

    var postData = 't4874=' + newStatusId + '&t4863=' + timestamp + '&_xsrf=' + xsrf;
    xhr.send(postData);
}

// Copy contact to clipboard
function copyContact(value, type, event){
    // Prevent card drag from starting
    if(event){
        event.stopPropagation();
    }

    // Copy to clipboard using the legacy method for compatibility
    var $temp = $("<input>");
    $("body").append($temp);
    $temp.val(value).select();
    document.execCommand("copy");
    $temp.remove();

    // Show visual feedback
    var icon = event.target;
    var originalText = icon.textContent;
    var originalTitle = icon.title;

    // Change icon to checkmark temporarily
    icon.textContent = '‚úì';
    icon.title = '–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ –≤ –±—É—Ñ–µ—Ä';
    icon.style.backgroundColor = 'rgba(34, 197, 94, 0.25)'; // Green background
    icon.style.color = 'rgba(34, 197, 94, 0.9)'; // Green text

    // Restore original icon after 1.5 seconds
    setTimeout(function(){
        icon.textContent = originalText;
        icon.title = originalTitle;
        icon.style.backgroundColor = '';
        icon.style.color = '';
    }, 1500);
}

// Load sources, distributors, and partners data
function loadSourcesAndDistributors(){
    // Load sources
    var xhr1 = new XMLHttpRequest();
    xhr1.open('GET', 'https://' + window.location.hostname + '/' + db + '/report/4500?JSON_KV', true);
    xhr1.onload = function(){
        if(xhr1.status === 200){
            try{
                sourcesData = JSON.parse(xhr1.responseText);
                populateSourcesDropdown();
            } catch(e){
                console.error('Error parsing sources data:', e);
            }
        } else {
            console.error('Error loading sources:', xhr1.status);
        }
    };
    xhr1.onerror = function(){
        console.error('Network error loading sources');
    };
    xhr1.send();

    // Load distributors
    var xhr2 = new XMLHttpRequest();
    xhr2.open('GET', 'https://' + window.location.hostname + '/' + db + '/report/4506?JSON_KV', true);
    xhr2.onload = function(){
        if(xhr2.status === 200){
            try{
                distributorsData = JSON.parse(xhr2.responseText);
                populateDistributorsDropdown();
            } catch(e){
                console.error('Error parsing distributors data:', e);
            }
        } else {
            console.error('Error loading distributors:', xhr2.status);
        }
    };
    xhr2.onerror = function(){
        console.error('Network error loading distributors');
    };
    xhr2.send();

    // Load partners
    var xhr3 = new XMLHttpRequest();
    xhr3.open('GET', 'https://' + window.location.hostname + '/' + db + '/report/5089?JSON_KV', true);
    xhr3.onload = function(){
        if(xhr3.status === 200){
            try{
                partnersData = JSON.parse(xhr3.responseText);
                populatePartnersDropdown();
            } catch(e){
                console.error('Error parsing partners data:', e);
            }
        } else {
            console.error('Error loading partners:', xhr3.status);
        }
    };
    xhr3.onerror = function(){
        console.error('Network error loading partners');
    };
    xhr3.send();
}

function populateSourcesDropdown(){
    var select = $('#recordSource');
    select.find('option:not(:first)').remove();
    sourcesData.forEach(function(source){
        var option = $('<option></option>');
        option.val(source['–ò—Å—Ç–æ—á–Ω–∏–∫ID']);
        option.text(source['–ò—Å—Ç–æ—á–Ω–∏–∫']);
        select.append(option);
    });
}

function populateDistributorsDropdown(){
    var select = $('#recordDistributor');
    select.find('option:not(:first)').remove();
    distributorsData.forEach(function(distributor){
        var option = $('<option></option>');
        option.val(distributor['–î–∏—Å—Ç—Ä–∏–±—å—é—Ç–æ—ÄID']);
        option.text(distributor['–î–∏—Å—Ç—Ä–∏–±—å—é—Ç–æ—Ä']);
        select.append(option);
    });
}

function populatePartnersDropdown(){
    var select = $('#recordPartner');
    select.find('option:not(:first)').remove();
    partnersData.forEach(function(partner){
        var option = $('<option></option>');
        option.val(partner['–ü–∞—Ä—Ç–Ω–µ—ÄID']);
        option.text(partner['–ü–∞—Ä—Ç–Ω–µ—Ä']);
        select.append(option);
    });
}

// Load managers list for task executor dropdown
function loadManagersList(){
    var xhr = new XMLHttpRequest();
    xhr.open('GET', 'https://' + window.location.hostname + '/' + db + '/report/5230?JSON_KV', true);
    xhr.onload = function(){
        if(xhr.status === 200){
            try{
                console.log('loadManagersList');
                managersData = JSON.parse(xhr.responseText);
                populateManagerSelect();
            } catch(e){
                console.error('Error parsing managers data:', e);
            }
        } else {
            console.error('Error loading managers:', xhr.status);
        }
    };
    xhr.onerror = function(){
        console.error('Network error loading managers');
    };
    xhr.send();
}

// Populate manager select dropdown
function populateManagerSelect() {
    var select = document.getElementById('managerSelect');
    if (!select) return;

    // Clear existing options
    select.innerHTML = '';

    // Populate options
    managersData.forEach(function(manager) {
        var option = document.createElement('option');
        option.value = manager['–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—åID'];
        option.text = manager['–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å'];

        // Set selected: prioritize saved cookie, then window.uid
        if (savedManagerId) {
            if (manager['–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—åID'] == savedManagerId) {
                option.selected = true;
                currentManagerId = savedManagerId;
            }
        } else if (typeof window.uid !== 'undefined' && manager['–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—åID'] == window.uid) {
            option.selected = true;
            currentManagerId = window.uid;
        }

        select.appendChild(option);
    });

    // If no manager was selected, select the first one
    if (!currentManagerId && managersData.length > 0) {
        currentManagerId = managersData[0]['–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—åID'];
        select.value = currentManagerId;
    }
}

// Load task types list for task type dropdown
function loadTaskTypesList(){
    var xhr = new XMLHttpRequest();
    xhr.open('GET', 'https://' + window.location.hostname + '/' + db + '/report/5241?JSON_KV', true);
    xhr.onload = function(){
        if(xhr.status === 200){
            try{
                taskTypesData = JSON.parse(xhr.responseText);
            } catch(e){
                console.error('Error parsing task types data:', e);
            }
        } else {
            console.error('Error loading task types:', xhr.status);
        }
    };
    xhr.onerror = function(){
        console.error('Network error loading task types');
    };
    xhr.send();
}

function openAddRecordModal(statusId, statusName){
    currentStatusId = statusId;
    currentStatusName = statusName;

    // Reset form
    $('#addRecordForm')[0].reset();
    $('#recordStatus').text(statusName);

    // Show modal
    $('#addRecordModal').addClass('active');
}

function closeAddRecordModal(){
    $('#addRecordModal').removeClass('active');
    currentStatusId = null;
    currentStatusName = null;
}

function submitAddRecord(){
    // Get form values
    var name = $('#recordName').val().trim();
    var sourceId = $('#recordSource').val();
    var partnerId = $('#recordPartner').val();
    var phone = $('#recordPhone').val().trim();
    var email = $('#recordEmail').val().trim();

    // Clear previous error states
    $('.kanban-form-input, .kanban-form-select').removeClass('error');

    // Validate required fields
    var hasError = false;

    if(!name){
        $('#recordName').addClass('error');
        hasError = true;
    }

    if(!sourceId){
        $('#recordSource').addClass('error');
        hasError = true;
    }
/*
    if(!partnerId){
        $('#recordPartner').addClass('error');
        hasError = true;
    }
*/
    if(!phone && !email){
        $('#recordPhone').addClass('error');
        $('#recordEmail').addClass('error');
        hasError = true;
    }

    if(hasError){
        alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è:\n- –ù–∞–∑–≤–∞–Ω–∏–µ\n- –ü–∞—Ä—Ç–Ω–µ—Ä\n- –ò—Å—Ç–æ—á–Ω–∏–∫\n- –¢–µ–ª–µ—Ñ–æ–Ω –∏–ª–∏ Email');
        return;
    }

    // Disable submit button
    $('#submitButton').prop('disabled', true).text('–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ...');

    // Prepare POST data for client (EntityID = 332)
    var entityId = 332;
    var inn = $('#recordInn').val().trim();
    var distributorId = $('#recordDistributor').val();
    var contact = $('#recordContact').val().trim();
    var amount = $('#recordAmount').val().trim();

    var postData = 't332=' + encodeURIComponent(name) +
                   '&t4874=' + encodeURIComponent(currentStatusId) +
                   '&_xsrf=' + xsrf;

    if(inn){
        postData += '&t637=' + encodeURIComponent(inn);
    }
    if(partnerId){
        postData += '&t443=' + encodeURIComponent(partnerId);
    }
    if(distributorId){
        postData += '&t4862=' + encodeURIComponent(distributorId);
    }
    if(phone){
        postData += '&t4536=' + encodeURIComponent(phone);
    }
    if(email){
        postData += '&t4537=' + encodeURIComponent(email);
    }
    if(contact){
        postData += '&t4538=' + encodeURIComponent(contact);
    }
    if(sourceId){
        postData += '&t4861=' + encodeURIComponent(sourceId);
    }
    if(amount){
        postData += '&t4864=' + encodeURIComponent(amount);
    }

    // Submit via POST
    var xhr = new XMLHttpRequest();
    xhr.open('POST', 'https://' + window.location.hostname + '/' + db + '/_m_new/' + entityId + '?JSON&up=1', true);
    xhr.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');
    xhr.onload = function(){
        $('#submitButton').prop('disabled', false).text('–°–æ—Ö—Ä–∞–Ω–∏—Ç—å');
        if(xhr.status === 200){
            try{
                var response = JSON.parse(xhr.responseText);
                console.log('Record created:', response);

                // Check for warning in response - show it and stay in edit mode
                if(response.warning && response.warning !== ''){
                    alert('–ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ: ' + response.warning);
                    // Don't close modal, stay in edit mode
                    return;
                }

                closeAddRecordModal();
                // Reload kanban to show new record
                loadKanbanData();
            } catch(e){
                console.error('Error parsing response:', e);
                alert('–ó–∞–ø–∏—Å—å —Å–æ–∑–¥–∞–Ω–∞, –Ω–æ –≤–æ–∑–Ω–∏–∫–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ –æ—Ç–≤–µ—Ç–∞');
                closeAddRecordModal();
                loadKanbanData();
            }
        } else {
            console.error('Error creating record:', xhr.status, xhr.responseText);
            alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∑–∞–ø–∏—Å–∏: ' + xhr.status);
        }
    };
    xhr.onerror = function(){
        $('#submitButton').prop('disabled', false).text('–°–æ—Ö—Ä–∞–Ω–∏—Ç—å');
        console.error('Network error creating record');
        alert('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∑–∞–ø–∏—Å–∏');
    };
    xhr.send(postData);
}

// Close modal when clicking outside
$(document).on('click', function(event){
    if(event.target.id === 'addRecordModal'){
        closeAddRecordModal();
    }
});

// Load data on page load
$(document).ready(function(){
    restoreUserPreferences();
    loadKanbanData();
    loadSourcesAndDistributors();
    loadProductsList();
    loadManagersList();
    loadTaskTypesList();
    loadEditFormStatuses();
});

// Load all statuses for edit form (unfiltered)
function loadEditFormStatuses(){
    var xhr = new XMLHttpRequest();
    xhr.open('GET', 'https://' + window.location.hostname + '/' + db + '/report/3796?JSON_KV&FR_partners=%25', true);
    xhr.onload = function(){
        if(xhr.status === 200){
            try{
                editFormStatusesData = JSON.parse(xhr.responseText);
            } catch(e){
                console.error('Error parsing edit form statuses:', e);
            }
        }
    };
    xhr.send();
}

// Client edit modal functionality
var currentEditClientId = null;
var clientMetadataCache = null;
var clientTypeId = 332;  // Client type ID

function openClientEditForm(clientId){
    currentEditClientId = clientId;

    // Load client data using IntegramTable form
    var xhr = new XMLHttpRequest();
    xhr.open('GET', 'https://' + window.location.hostname + '/' + db + '/edit_obj/' + clientId + '?JSON', true);
    xhr.onload = function(){
        if(xhr.status === 200){
            try{
                var recordData = JSON.parse(xhr.responseText);

                // Load type metadata
                var typeXhr = new XMLHttpRequest();
                typeXhr.open('GET', 'https://' + window.location.hostname + '/' + db + '/type_edit/' + clientTypeId + '?JSON', true);
                typeXhr.onload = function(){
                    if(typeXhr.status === 200){
                        try{
                            var typeData = JSON.parse(typeXhr.responseText);
                            var metadata = typeData.type || {};

                            // Hide the old modal if it exists
                            $('#editClientModal').removeClass('active');

                            // Create a temporary table instance to use its form rendering
                            var tempOptions = {
                                instanceName: 'tempClientTable'
                            };

                            // Create a simple object with the renderEditFormModal method
                            var tempTable = {
                                options: tempOptions,
                                parseAttrs: function(attrs){
                                    var result = {required: false, alias: '', multi: false};
                                    if(!attrs) return result;
                                    var parts = attrs.split(':');
                                    if(parts[0]) result.alias = parts[0];
                                    if(attrs.includes('!NULL:')) result.required = true;
                                    if(attrs.includes('MULTI:')) result.multi = true;
                                    return result;
                                },
                                escapeHtml: function(str){
                                    if(!str) return '';
                                    return String(str).replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;').replace(/'/g, '&#039;');
                                },
                                renderEditFormModal: IntegramTable.prototype.renderEditFormModal
                            };

                            // Use IntegramTable's form rendering
                            tempTable.renderEditFormModal(metadata, recordData, false, clientTypeId);
                        } catch(e){
                            console.error('Error rendering form:', e);
                            alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–¥–≥–æ—Ç–æ–≤–∫–µ —Ñ–æ—Ä–º—ã: ' + e.message);
                        }
                    } else {
                        alert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö —Ç–∏–ø–∞');
                    }
                };
                typeXhr.send();
            } catch(e){
                alert('–û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ –¥–∞–Ω–Ω—ã—Ö: ' + e.message);
            }
        } else {
            alert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö –∫–ª–∏–µ–Ω—Ç–∞: ' + xhr.status);
        }
    };
    xhr.onerror = function(){
        alert('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –¥–∞–Ω–Ω—ã—Ö');
    };
    xhr.send();
}

function closeEditClientModal(){
    $('#editClientModal').removeClass('active');
    currentEditClientId = null;
}


// Task creation modal functionality
var currentTaskLeadId = null;
var currentTaskButton = null;
var taskTypeId = 3596;  // Task type ID (–ó–∞–¥–∞—á–∞ –¥–ª—è –∫–æ–º–∞–Ω–¥—ã)

function openTaskCreateForm(leadId, button){
    currentTaskLeadId = leadId;
    currentTaskButton = button;
    $('#createTaskModal').addClass('active');
    renderTaskCreateForm();
}

function closeTaskCreateModal(){
    $('#createTaskModal').removeClass('active');
    currentTaskLeadId = null;
    currentTaskButton = null;
}

function renderTaskCreateForm(){
    var html = '<form id="createTaskForm">';

    // Task name field
    html += '<div class="kanban-edit-form-group">';
    html += '<label class="kanban-edit-form-label required">–ù–∞–∑–≤–∞–Ω–∏–µ –∑–∞–¥–∞—á–∏</label>';
    html += '<input type="text" class="kanban-edit-form-input" id="taskName" name="t3596">';
    html += '</div>';

    // Executor field (–ò—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å)
    html += '<div class="kanban-edit-form-group">';
    html += '<label class="kanban-edit-form-label">–ò—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å</label>';
    html += '<select class="kanban-edit-form-select" id="taskExecutor" name="t3942">';
    html += '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—è</option>';
    managersData.forEach(function(manager){
        var selected = (typeof window.uid !== 'undefined' && manager['–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—åID'] == window.uid) ? 'selected' : '';
        html += '<option value="' + manager['–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—åID'] + '" ' + selected + '>' + manager['–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å'] + '</option>';
    });
    html += '</select>';
    html += '</div>';

    // Task type field (–¢–∏–ø –∑–∞–¥–∞—á–∏)
    html += '<div class="kanban-edit-form-group">';
    html += '<label class="kanban-edit-form-label">–¢–∏–ø –∑–∞–¥–∞—á–∏</label>';
    html += '<select class="kanban-edit-form-select" id="taskType" name="t4299">';
    html += '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø –∑–∞–¥–∞—á–∏</option>';
    taskTypesData.forEach(function(taskType){
        html += '<option value="' + taskType['–¢–∏–ø –∑–∞–¥–∞—á–∏ID'] + '">' + taskType['–¢–∏–ø –∑–∞–¥–∞—á–∏'] + '</option>';
    });
    html += '</select>';
    html += '</div>';

    // Due date field
    html += '<div class="kanban-edit-form-group">';
    html += '<label class="kanban-edit-form-label required">–°—Ä–æ–∫ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è</label>';
    html += '<input type="datetime-local" class="kanban-edit-form-input" id="taskDueDate" name="taskDueDatePicker" required>';
    html += '<input type="hidden" id="taskDueDateHidden" name="t3888">';
    html += '</div>';

    html += '</form>';

    $('#createTaskModalBody').html(html);

    // Handle datetime picker change
    $('#taskDueDate').on('change', function(){
        var value = $(this).val();
        if(value){
            // Convert to DD.MM.YYYY HH:MM format
            var date = new Date(value);
            var day = String(date.getDate()).padStart(2, '0');
            var month = String(date.getMonth() + 1).padStart(2, '0');
            var year = date.getFullYear();
            var hours = String(date.getHours()).padStart(2, '0');
            var minutes = String(date.getMinutes()).padStart(2, '0');
            $('#taskDueDateHidden').val(day + '.' + month + '.' + year + ' ' + hours + ':' + minutes);
        } else {
            $('#taskDueDateHidden').val('');
        }
    });

    // Handle task type selection - auto-fill task name when empty
    $('#taskType').on('change', function(){
        var taskNameField = $('#taskName');
        var currentTaskName = taskNameField.val().trim();

        // Only auto-fill if task name field is empty
        if(!currentTaskName){
            var selectedOption = $(this).find('option:selected');
            var taskTypeName = selectedOption.text();

            // Only set if a valid task type is selected (not the placeholder)
            if(selectedOption.val()){
                taskNameField.val(taskTypeName);
            }
        }
    });
}

function submitCreateTask(){
    if(!currentTaskLeadId) return;

    var taskName = $('#taskName').val().trim();
    if(!taskName){
        $('#taskName').addClass('error');
        alert('–ù–∞–∑–≤–∞–Ω–∏–µ –∑–∞–¥–∞—á–∏ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –¥–ª—è –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è');
        return;
    }

    var dueDate = $('#taskDueDateHidden').val();
    if(!dueDate){
        $('#taskDueDate').addClass('error');
        alert('–°—Ä–æ–∫ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω –¥–ª—è –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è');
        return;
    }

    $('#createTaskSubmitButton').prop('disabled', true).text('–°–æ–∑–¥–∞–Ω–∏–µ...');

    // Build POST data
    var postData = 't' + taskTypeId + '=' + encodeURIComponent(taskName);
    postData += '&t4547=' + encodeURIComponent(currentTaskLeadId);  // Link to lead (client ID)

    // Add current user ID
    if(typeof window.uid !== 'undefined' && window.uid){
        postData += '&t4844=' + encodeURIComponent(window.uid);
    }

    // Add executor (–ò—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å)
    var executor = $('#taskExecutor').val();
    if(executor){
        postData += '&t3942=' + encodeURIComponent(executor);
    }

    // Add task type (–¢–∏–ø –∑–∞–¥–∞—á–∏)
    var taskType = $('#taskType').val();
    if(taskType){
        postData += '&t4299=' + encodeURIComponent(taskType);
    }

    // dueDate already validated above
    postData += '&t3888=' + encodeURIComponent(dueDate);

    postData += '&_xsrf=' + xsrf;

    var xhr = new XMLHttpRequest();
    xhr.open('POST', 'https://' + window.location.hostname + '/' + db + '/_m_new/' + taskTypeId + '?JSON&up=1', true);
    xhr.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');
    xhr.onload = function(){
        $('#createTaskSubmitButton').prop('disabled', false).text('–°–æ–∑–¥–∞—Ç—å');
        if(xhr.status === 200){
            try{
                var response = JSON.parse(xhr.responseText);
                console.log('Task created:', response);

                // Update task count in the badge
                updateTaskCount(currentTaskLeadId);

                closeTaskCreateModal();
            } catch(e){
                console.error('Error parsing response:', e);
                updateTaskCount(currentTaskLeadId);
                closeTaskCreateModal();
            }
        } else {
            console.error('Error creating task:', xhr.status, xhr.responseText);
            alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∑–∞–¥–∞—á–∏: ' + xhr.status);
        }
    };
    xhr.onerror = function(){
        $('#createTaskSubmitButton').prop('disabled', false).text('–°–æ–∑–¥–∞—Ç—å');
        console.error('Network error creating task');
        alert('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∑–∞–¥–∞—á–∏');
    };
    xhr.send(postData);
}

function updateTaskCount(leadId){
    // Find the task button for this lead and update the count
    var taskButton = $('.kanban-card-tasks-button[data-lead-id="' + leadId + '"]');
    if(taskButton.length > 0){
        var countSpan = taskButton.find('.tasks-count');
        if(countSpan.length > 0){
            var currentCount = parseInt(countSpan.text()) || 0;
            var newCount = currentCount + 1;
            countSpan.text(newCount);

            // Update button class if it was 'no-tasks'
            if(taskButton.hasClass('no-tasks')){
                taskButton.removeClass('no-tasks').addClass('has-tasks');

                // Convert span to anchor with link
                var card = taskButton.closest('.kanban-card');
                var cardLeadId = card.data('lead-id');
                var tasksUrl = '/' + db + '/object/3596?FR_4547=@' + cardLeadId;

                var newButton = $('<a href="' + tasksUrl + '" target="tasks" class="kanban-card-tasks-button has-tasks" data-lead-id="' + leadId + '" onclick="event.stopPropagation();">–ó–∞–¥–∞—á–∏: <span class="tasks-count">' + newCount + '</span></a>');
                taskButton.replaceWith(newButton);
            }
        }
    }
}

// Deal creation modal functionality
var currentDealLeadId = null;
var currentDealButton = null;
var dealTypeId = 430;  // Deal type ID (–°–¥–µ–ª–∫–∞)

function openDealCreateForm(leadId, button){
    currentDealLeadId = leadId;
    currentDealButton = button;
    $('#createDealModal').addClass('active');
    renderDealCreateForm();
}

function closeDealCreateModal(){
    $('#createDealModal').removeClass('active');
    currentDealLeadId = null;
    currentDealButton = null;
}

function renderDealCreateForm(){
    var html = '<form id="createDealForm">';

    // Quantity field (–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ)
    html += '<div class="kanban-edit-form-group">';
    html += '<label class="kanban-edit-form-label">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ</label>';
    html += '<input type="number" class="kanban-edit-form-input" id="dealQuantity" name="t447" value="1" min="1" step="1">';
    html += '</div>';

    // Product field (–ü—Ä–æ–¥—É–∫—Ç) - required
    html += '<div class="kanban-edit-form-group">';
    html += '<label class="kanban-edit-form-label required">–ü—Ä–æ–¥—É–∫—Ç</label>';
    html += '<select class="kanban-edit-form-select" id="dealProduct" name="t449" required>';
    html += '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–æ–¥—É–∫—Ç</option>';
    productsData.forEach(function(product){
        // Default to currently selected product in productRadioGroup
        var selected = (currentProductId !== 'all' && product['–ü—Ä–æ–¥—É–∫—ÇID'] == currentProductId) ? 'selected' : '';
        html += '<option value="' + product['–ü—Ä–æ–¥—É–∫—ÇID'] + '" ' + selected + '>' + product['–ü—Ä–æ–¥—É–∫—Ç'] + '</option>';
    });
    html += '</select>';
    html += '</div>';

    // Amount field (–°—Ç–æ–∏–º–æ—Å—Ç—å)
    html += '<div class="kanban-edit-form-group">';
    html += '<label class="kanban-edit-form-label">–°—Ç–æ–∏–º–æ—Å—Ç—å (‚ÇΩ)</label>';
    html += '<input type="number" class="kanban-edit-form-input" id="dealAmount" name="t5309" min="0" step="0.01">';
    html += '</div>';

    // Partner field (–ü–∞—Ä—Ç–Ω–µ—Ä)
    html += '<div class="kanban-edit-form-group">';
    html += '<label class="kanban-edit-form-label">–ü–∞—Ä—Ç–Ω–µ—Ä</label>';
    html += '<select class="kanban-edit-form-select" id="dealPartner" name="t479">';
    html += '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ –ø–∞—Ä—Ç–Ω–µ—Ä–∞</option>';
    partnersData.forEach(function(partner){
        html += '<option value="' + partner['–ü–∞—Ä—Ç–Ω–µ—ÄID'] + '">' + partner['–ü–∞—Ä—Ç–Ω–µ—Ä'] + '</option>';
    });
    html += '</select>';
    html += '</div>';

    // Note field (–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ)
    html += '<div class="kanban-edit-form-group">';
    html += '<label class="kanban-edit-form-label">–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ</label>';
    html += '<textarea class="kanban-edit-form-textarea" id="dealNote" name="t636" rows="4"></textarea>';
    html += '</div>';

    html += '</form>';

    $('#createDealModalBody').html(html);
}

function submitCreateDeal(){
    if(!currentDealLeadId) return;

    var productId = $('#dealProduct').val();
    if(!productId){
        $('#dealProduct').addClass('error');
        alert('–ü—Ä–æ–¥—É–∫—Ç –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω –¥–ª—è –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è');
        return;
    }

    $('#createDealSubmitButton').prop('disabled', true).text('–°–æ–∑–¥–∞–Ω–∏–µ...');

    // Build POST data
    var postData = '';

    // Add quantity (t447)
    var quantity = $('#dealQuantity').val();
    if(quantity){
        postData += 't447=' + encodeURIComponent(quantity);
    }

    // Add hardcoded t5315=1
    postData += '&t5315=1';

    // Add product (t449) - required
    postData += '&t449=' + encodeURIComponent(productId);

    // Add amount (t5309)
    var amount = $('#dealAmount').val();
    if(amount){
        postData += '&t5309=' + encodeURIComponent(amount);
    }

    // Add note (t636)
    var note = $('#dealNote').val();
    if(note){
        postData += '&t636=' + encodeURIComponent(note);
    }

    // Add partner (t479)
    var partnerId = $('#dealPartner').val();
    if(partnerId){
        postData += '&t479=' + encodeURIComponent(partnerId);
    }

    postData += '&_xsrf=' + xsrf;

    var xhr = new XMLHttpRequest();
    xhr.open('POST', 'https://' + window.location.hostname + '/' + db + '/_m_new/' + dealTypeId + '?JSON&up=' + currentDealLeadId, true);
    xhr.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');
    xhr.onload = function(){
        $('#createDealSubmitButton').prop('disabled', false).text('–°–æ–∑–¥–∞—Ç—å');
        if(xhr.status === 200){
            try{
                var response = JSON.parse(xhr.responseText);
                console.log('Deal created:', response);

                // Update deal count in the badge
                updateDealCount(currentDealLeadId);

                closeDealCreateModal();
            } catch(e){
                console.error('Error parsing response:', e);
                updateDealCount(currentDealLeadId);
                closeDealCreateModal();
            }
        } else {
            console.error('Error creating deal:', xhr.status, xhr.responseText);
            alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ —Å–¥–µ–ª–∫–∏: ' + xhr.status);
        }
    };
    xhr.onerror = function(){
        $('#createDealSubmitButton').prop('disabled', false).text('–°–æ–∑–¥–∞—Ç—å');
        console.error('Network error creating deal');
        alert('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ —Å–¥–µ–ª–∫–∏');
    };
    xhr.send(postData);
}

function updateDealCount(leadId){
    // Find the deal button for this lead and update the count
    var dealButton = $('.kanban-card-deals-button[data-lead-id="' + leadId + '"]');
    if(dealButton.length > 0){
        var countSpan = dealButton.find('.deals-count');
        if(countSpan.length > 0){
            var currentCount = parseInt(countSpan.text()) || 0;
            var newCount = currentCount + 1;
            countSpan.text(newCount);

            // Update button class if it was 'no-deals'
            if(dealButton.hasClass('no-deals')){
                dealButton.removeClass('no-deals').addClass('has-deals');

                // Convert span to anchor with link
                var card = dealButton.closest('.kanban-card');
                var cardLeadId = card.data('lead-id');
                var dealsUrl = '/' + db + '/smartq/6271?FR_–ö–ª–∏–µ–Ω—ÇID=' + cardLeadId;

                var newButton = $('<a href="' + dealsUrl + '" target="deals" class="kanban-card-deals-button has-deals" data-lead-id="' + leadId + '" onclick="event.stopPropagation();">–°–¥–µ–ª–∫–∏: <span class="deals-count">' + newCount + '</span></a>');
                dealButton.replaceWith(newButton);
            }
        }
    }
}

// Helper function to escape HTML
function escapeHtml(text){
    // Handle null, undefined, and their string representations
    if(text === null || text === undefined) return '';
    var str = String(text).trim();
    var strLower = str.toLowerCase();
    if(strLower === 'undefined' || strLower === 'null' || str === '') return '';
    return str.replace(/&/g, '&amp;')
              .replace(/</g, '&lt;')
              .replace(/>/g, '&gt;')
              .replace(/"/g, '&quot;')
              .replace(/'/g, '&#039;');
}

// Helper function to safely get value (handles undefined/null strings)
function safeValue(value){
    if(value === null || value === undefined) return '';
    var str = String(value).trim();
    var strLower = str.toLowerCase();
    if(strLower === 'undefined' || strLower === 'null' || str === '') return '';
    return str;
}

// Helper function to safely get requisite value
function getReqValue(reqs, key){
    if(!reqs || !reqs[key]) return '';
    var req = reqs[key];
    // Handle case where req itself might be a primitive value instead of an object
    if(typeof req !== 'object' || req === null) return '';
    var value = req.value;
    // Handle null, undefined, and their string representations
    if(value === null || value === undefined) return '';
    var str = String(value).trim();
    var strLower = str.toLowerCase();
    if(strLower === 'undefined' || strLower === 'null' || str === '') return '';
    return str;
}

// Close modals when clicking outside
$(document).on('click', function(event){
    if(event.target.id === 'editClientModal'){
        closeEditClientModal();
    }
    if(event.target.id === 'createTaskModal'){
        closeTaskCreateModal();
    }
    if(event.target.id === 'createDealModal'){
        closeDealCreateModal();
    }
});
</script>
